<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ููุธููุฉ ุงูุฅุญุตุงุก - ูุญุงูุธุฉ ุงูุฌูุฒุฉ</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</head>

<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-card">
            <img src="logo.jpg" alt="Logo" style="width: 60px; margin-bottom: 15px;">
            <h2>ูุญุงูุธุฉ ุงูุฌูุฒุฉ</h2>
            <h3>ููุธููุฉ ุฅุญุตุงุก ุงูุชุนููู ุงูุงุจุชุฏุงุฆู</h3>
            <p style="margin-top: -15px; margin-bottom: 20px; color: #666; font-size: 0.9rem;">ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ
                - ุงูุชุนููู ุงูุงุจุชุฏุงุฆู</p>

            <!-- Dynamic Dropdowns -->
            <div id="loading-schools" style="margin: 20px 0; color: #666;">ุฌุงุฑู ุชุญููู ูุงุฆูุฉ ุงููุฏุงุฑุณ...</div>

            <div id="login-form-area" style="display: none; width: 100%;">
                <select id="schoolTypeSelect" onchange="filterSchools()">
                    <option value="">ุงุฎุชุฑ ููุน ุงูุชุนููู...</option>
                </select>

                <select id="schoolNameSelect">
                    <option value="">ุงุฎุชุฑ ุงููุฏุฑุณุฉ...</option>
                </select>

                <input type="password" id="schoolCode" placeholder="ููุฏ ุงููุฏุฑุณุฉ (ุงูุฑูู ุงูุณุฑู)">
                <button class="login-btn" onclick="login()">ุชุณุฌูู ุงูุฏุฎูู</button>

                <div style="margin-top: 15px;">
                    <a href="#" onclick="showPasswordModal()"
                        style="font-size: 0.9rem; color: var(--primary-color); text-decoration: none;">ุชุบููุฑ ูููุฉ
                        ุงููุฑูุฑ</a>
                    <span style="color:#ccc; margin:0 5px;">|</span>
                    <a href="#" onclick="showAdminLogin()"
                        style="font-size: 0.9rem; color: #e74c3c; text-decoration: none;">ุฏุฎูู ุงููุณุคูู (Admin)</a>
                </div>
            </div>
        </div>
        <div class="copyright-footer" style="background: transparent; border: none; font-size: 0.8rem;">
            ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ 2026 &copy; <br>
            <span style="display:block; margin: 5px 0;">ุงููุณุฎุฉ 2.0</span>
            ุชุญุช ุฅุดุฑุงู: <span style="font-weight: bold; color: var(--bs-indigo);">ุฃ/ ูุดุงู ูุญููุฏ</span><br>
            ุชุทููุฑ: <span style="font-family: sans-serif; font-weight: bold;">Diaa El Attar</span>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="modal">
        <div class="modal-content" style="border-top: 5px solid #e74c3c;">
            <h3 style="color: #e74c3c;">ุฏุฎูู ุงููุณุคูู</h3>
            <input type="password" id="admin-pass-input" placeholder="ูููุฉ ูุฑูุฑ ุงููุณุคูู">
            <button class="modal-btn" style="background: #e74c3c; color: white;"
                onclick="submitAdminLogin()">ุฏุฎูู</button>
            <button class="modal-btn" style="background: #7f8c8d; color: white;"
                onclick="closeModal('admin-login-modal')">ุฅูุบุงุก</button>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--primary-color);">ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</h3>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">ุงุฎุชุฑ ุงููุฏุฑุณุฉ ูู ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ ุฃููุงู</p>

            <input type="password" id="old-pass" placeholder="ูููุฉ ุงููุฑูุฑ ุงููุฏููุฉ">
            <input type="text" id="new-pass" placeholder="ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ (ุฃุฑูุงู ููุท)"
                oninput="validateNumberInput(this)">

            <div style="margin-top: 15px;">
                <button class="modal-btn" style="background: var(--primary-color); color: white;"
                    onclick="changePassword()">ุญูุธ ุงูุชุบููุฑ</button>
                <button class="modal-btn" style="background: #e74c3c; color: white;"
                    onclick="closeModal('password-modal')">ุฅูุบุงุก</button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Screen -->
    <div id="admin-dashboard-screen">
        <div class="control-panel no-print">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="user-info">
                    <strong>ููุญุฉ ุชุญูู ุงููุณุคูู</strong>
                    <span style="margin: 0 10px; color: #ccc;">|</span>
                    <span id="admin-grade-title">ุงูุตู ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู</span>
                </div>
                <button onclick="logoutAdmin()" class="tab-btn" style="background: #e74c3c; color: white;">ุชุณุฌูู ุฎุฑูุฌ
                    ๐</button>
            </div>

            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #ddd;">

            <div class="tabs" style="justify-content: center; margin-bottom: 10px;">
                <button class="tab-btn active" onclick="loadAdminStats(3)">3 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="loadAdminStats(4)">4 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="loadAdminStats(5)">5 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="loadAdminStats(6)">6 ุงุจุชุฏุงุฆู</button>
            </div>

            <!-- Admin View Switcher -->
            <div class="tabs" style="justify-content: center; background: #f1f2f6; padding: 5px; border-radius: 10px;">
                <button class="tab-btn active" id="btn-view-reports" onclick="switchAdminView('reports')">๐ ุชูุฑูุฑ
                    ุงูุฅุญุตุงุก</button>
                <button class="tab-btn" id="btn-view-status" onclick="switchAdminView('status')">๐ซ ูููู
                    ุงููุฏุงุฑุณ</button>
                <button onclick="exportAdminToExcel()" class="tab-btn" style="background: #27ae60; color: white;">๐ฅ
                    ุชุตุฏูุฑ Excel</button>
                <button onclick="printAdminReport()" class="tab-btn"
                    style="background: var(--primary-color); color: white;">๐จ๏ธ ุทุจุงุนุฉ</button>
            </div>
        </div>

        <!-- View 1: Statistical Reports -->
        <div id="admin-view-reports" class="table-container">
            <!-- Content will be injected dynamically -->
        </div>

        <h3 style="text-align: center; margin-bottom: 20px; color: var(--primary-color);">ุจูุงู ุฅุญุตุงุฆู ูุฌูุน</h3>

        <!-- Aggregated Table -->
        <div style="overflow-x: auto;">
            <table class="admin-table-official" style="width: 100%; margin-bottom: 30px; font-size: 11px;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th rowspan="2">ููุน ุงูุชุนููู</th>
                        <th rowspan="2">ุนุฏุฏ ุงููุฏุงุฑุณ</th>
                        <th colspan="3">ุงููููุฏ</th>
                        <th colspan="3">ุงูุญุงุถุฑ</th>
                        <th colspan="3">50% ูุฃูุซุฑ (ูุงุฌุญ)</th>
                        <th colspan="3">ุฃูู ูู 50% (ุฏูู ุงููุณุชูู)</th>
                        <th colspan="3">ุงูุบูุงุจ</th>
                    </tr>
                    <tr style="background: #f1f2f6;">
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                    </tr>
                </thead>
                <tbody id="admin-agg-body">
                    <!-- JS Injected -->
                </tbody>
            </table>
        </div>

        <!-- Subjects Aggregated Table -->
        <h4 style="text-align: center; text-decoration: underline; margin: 10px 0;">ูุณุจ ุงููุฌุงุญ ูู ุงูููุงุฏ</h4>
        <div style="overflow-x: auto;">
            <table class="admin-table-official" style="width: 100%;">
                <thead style="background-color: #fce4ec; color: #c2185b;">
                    <tr>
                        <th rowspan="2">ุงููุงุฏุฉ</th>
                        <th colspan="3">ุงููุชูุฏููู</th>
                        <th colspan="3">ุงูุญุงุถุฑูู</th>
                        <th colspan="3">ุงููุงุฌุญูู</th>
                        <th rowspan="2">ุงููุณุจุฉ %</th>
                    </tr>
                    <tr>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                    </tr>
                </thead>
                <tbody id="admin-subj-body">
                    <!-- JS Injected -->
                </tbody>
            </table>
        </div>

        <!-- Signatures -->
        <div class="print-footer-container">
            <div class="signature-block">
                <div class="sig-title">ุฑุฆูุณ ุงููุฌูุฉ</div>
                <div
                    style="margin-top: 50px; border-top: 1px solid #000; display: inline-block; padding-top: 5px; min-width: 150px;">
                    ุงูุงุณู ูุงูุชูููุน</div>
            </div>
            <div class="signature-block">
                <div class="sig-title">ูุฏูุฑ ุนุงู ุงูุฅุฏุงุฑุฉ</div>
                <div
                    style="margin-top: 50px; border-top: 1px solid #000; display: inline-block; padding-top: 5px; min-width: 150px;">
                    ุงูุงุณู ูุงูุชูููุน</div>
            </div>
        </div>
    </div>

    <!-- View 2: School Status -->
    <div id="admin-view-status" class="table-container" style="display: none;">
        <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
            <div class="status-card success">
                <h4>ุงููุฏุงุฑุณ ุงููุณุฌูุฉ (<span id="count-submitted">0</span>)</h4>
                <ul id="list-submitted" class="status-list"></ul>
            </div>
            <div class="status-card warning">
                <h4>ูุฏุงุฑุณ ูู ุชุณุฌู (<span id="count-missing">0</span>)</h4>
                <ul id="list-missing" class="status-list"></ul>
            </div>
        </div>
    </div>
    </div>

    <!-- School Dashboard Screen (Data Entry) -->
    <div id="dashboard-screen">
        <div class="control-panel no-print">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="user-info">
                    <strong id="ui-school-name">ูุฏุฑุณุฉ...</strong>
                    <span id="ui-school-type"
                        style="font-size: 0.8rem; background: #eee; padding: 2px 8px; border-radius: 4px; margin-right: 5px;">ููุน
                        ุงูุชุนููู</span>
                </div>
                <div>
                    <button onclick="logout()" class="tab-btn" style="background: #e74c3c; color: white;">ุชุณุฌูู ุฎุฑูุฌ
                        ๐</button>
                </div>
            </div>

            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #ddd;">

            <div class="tabs" style="justify-content: center;">
                <button class="tab-btn active" onclick="showGrade(3)">3 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="showGrade(4)">4 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="showGrade(5)">5 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="showGrade(6)">6 ุงุจุชุฏุงุฆู</button>
            </div>
        </div>

        <!-- Print Header School -->
        <div class="print-header-container">
            <div class="ph-right">
                <h4>ูุฏูุฑูุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู ุจุงูุฌูุฒุฉ</h4>
                <h4>ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ</h4>
                <h4>ุงูุชุนููู ุงูุงุจุชุฏุงุฆู</h4>
                <h4 style="margin-top: 5px;">ูุฏุฑุณุฉ: <span id="print-school-name" style="font-weight: 400;">...</span>
                </h4>
            </div>
            <div class="ph-center">
                <h2 id="print-title">ุฅุญุตุงุก ูุตู ุงูุนุงู</h2>
                <h3 id="grade-title">ุงูุตู ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู</h3>
            </div>
            <div class="ph-left">
                <img src="logo.jpg" class="logo-img" alt="Logo">
            </div>
        </div>

        <h3 id="form-grade-title" class="no-print"
            style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">ุฅุฏุฎุงู ุจูุงูุงุช ุงูุฅุญุตุงุก</h3>

        <!-- General Stats Table (Input) -->
        <h4 style="margin: 10px 0;">ุฃููุงู: ุงูุฅุญุตุงุก ุงูุนุงู</h4>
        <div style="overflow-x:auto;">
            <table style="min-width: 800px;">
                <thead>
                    <tr>
                        <th rowspan="2">ุงูุจูุงู</th>
                        <th colspan="3">ุงููููุฏ</th>
                        <th colspan="3">ุงูุญุงุถุฑ</th>
                        <th colspan="3">50% ูุฃูุซุฑ (ูุงุฌุญ)</th>
                        <th colspan="3">ุฃูู ูู 50% (ุฏูู ุงููุณุชูู)</th>
                        <th colspan="3">ุงูุบูุงุจ</th>
                    </tr>
                    <tr>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="school-type-display" style="font-weight:bold;">-</td>

                        <!-- Enrolled -->
                        <td><input type="number" id="enr_b" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td><input type="number" id="enr_g" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td id="enr_t" style="background:#eee; font-weight:bold;">0</td>

                        <!-- Present -->
                        <td><input type="number" id="pre_b" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td><input type="number" id="pre_g" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td id="pre_t" style="background:#eee; font-weight:bold;">0</td>

                        <!-- Success -->
                        <td><input type="number" id="suc_b" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td><input type="number" id="suc_g" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td id="suc_t" style="background:#eee; font-weight:bold;">0</td>

                        <!-- Fail -->
                        <td><input type="number" id="fail_b" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td><input type="number" id="fail_g" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td id="fail_t" style="background:#eee; font-weight:bold;">0</td>

                        <!-- Absent -->
                        <td><input type="number" id="abs_b" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td><input type="number" id="abs_g" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td id="abs_t" style="background:#eee; font-weight:bold;">0</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Subjects Stats Table -->
        <h4 style="margin: 15px 0 10px;">ุซุงููุงู: ุฅุญุตุงุก ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ</h4>
        <div style="overflow-x:auto;">
            <table id="subjects-table" style="min-width: 800px;">
                <thead>
                    <tr>
                        <th rowspan="2">ุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉ</th>
                        <th colspan="3">ุงููุชูุฏููู</th>
                        <th colspan="3">ุงูุญุงุถุฑูู</th>
                        <th colspan="3">ุงููุงุฌุญูู</th>
                        <th rowspan="2">ุงููุณุจุฉ %</th>
                    </tr>
                    <tr>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                    </tr>
                </thead>
                <tbody id="subjects-body">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>
        </div>

        <button onclick="saveData()" class="action-btn no-print"
            style="width: 100%; margin-top: 20px; font-size: 1.2rem;">๐พ ุญูุธ ุงูุจูุงูุงุช</button>

        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
            <button onclick="prepareOfficialPrint()" class="action-btn no-print"
                style="flex:1; min-width: 150px; background: #2c3e50;">๐จ๏ธ ุทุจุงุนุฉ ุงูุชูุฑูุฑ ุงูุฑุณูู</button>
            <button onclick="exportToExcel()" class="action-btn no-print"
                style="flex:1; min-width: 150px; background: #27ae60;">๐ ุชุตุฏูุฑ Excel</button>
        </div>
    </div>

    <!-- Official Print Area for Schools (Isolated) -->
    <div id="school-print-area" class="print-only"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Professional Excel Library with Styling -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <!-- Professional Printing Library -->
    <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
    <link rel="stylesheet" href="https://printjs-4de6.kxcdn.com/print.min.css">

    <script>
        // *** RENAME THIS IF DEPLOYING NEW VERSION ***
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxRzMU_HC595ZhWg__yzRjruHCpS3eMwgJLFoE1eJlUaLQ7G7hgFJRh_oh3NyeNRP3A/exec";

        let currentSchool = {};
        let currentGrade = 3;
        let allSchoolsData = [];

        const subjectsConfig = {
            3: ["ุชุฑุจูุฉ ุฏูููุฉ", "ูุบุฉ ุนุฑุจูุฉ", "ูุบุฉ ุงูุฌููุฒูุฉ", "ุฑูุงุถูุงุช"],
            4: ["ุชุฑุจูุฉ ุฏูููุฉ", "ูุบุฉ ุนุฑุจูุฉ", "ูุบุฉ ุงูุฌููุฒูุฉ", "ุฑูุงุถูุงุช", "ุนููู", "ุฏุฑุงุณุงุช", "ุชูููููุฌูุง ุงููุนูููุงุช ICT"],
            5: ["ุชุฑุจูุฉ ุฏูููุฉ", "ูุบุฉ ุนุฑุจูุฉ", "ูุบุฉ ุงูุฌููุฒูุฉ", "ุฑูุงุถูุงุช", "ุนููู", "ุฏุฑุงุณุงุช", "ุชูููููุฌูุง ุงููุนูููุงุช ICT"],
            6: ["ุชุฑุจูุฉ ุฏูููุฉ", "ูุบุฉ ุนุฑุจูุฉ", "ูุบุฉ ุงูุฌููุฒูุฉ", "ุฑูุงุถูุงุช", "ุนููู", "ุฏุฑุงุณุงุช", "ุชูููููุฌูุง ุงููุนูููุงุช ICT"]
        };

        // Utility: Show Toast
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        window.onload = function () {
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getSchools" })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        allSchoolsData = data.schools;
                        populateTypes();
                        document.getElementById('loading-schools').style.display = 'none';
                        document.getElementById('login-form-area').style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loading-schools').innerHTML = `<span style="color:red; direction:ltr;">Error: ${err.message}</span><br>ุชุฃูุฏ ูู ุฅุนุฏุงุฏุงุช ุงููุดุฑ (Deploy) ูุฃู ุงูุตูุงุญูุงุช (Anyone).`;
                    Toast.fire({ icon: 'error', title: 'ูุดู ุงูุงุชุตุงู ุจุงูุฎุงุฏู', text: err.message });
                });
        };

        function populateTypes() {
            const typeSelect = document.getElementById('schoolTypeSelect');
            const types = [...new Set(allSchoolsData.map(s => s.type))];
            types.forEach(type => {
                let opt = document.createElement('option');
                opt.value = type;
                opt.innerText = type;
                typeSelect.appendChild(opt);
            });
        }

        function filterSchools() {
            const selectedType = document.getElementById('schoolTypeSelect').value;
            const nameSelect = document.getElementById('schoolNameSelect');
            nameSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุฏุฑุณุฉ...</option>';

            const filtered = allSchoolsData.filter(s => s.type === selectedType);
            filtered.forEach(s => {
                let opt = document.createElement('option');
                opt.value = s.name;
                opt.innerText = s.name;
                nameSelect.appendChild(opt);
            });
        }

        function login() {
            var schoolType = document.getElementById('schoolTypeSelect').value;
            var schoolName = document.getElementById('schoolNameSelect').value;
            var password = document.getElementById('schoolCode').value;

            if (!schoolType || !schoolName) {
                Swal.fire('ุชูุจูู', 'ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงูุชุนููู ูุงููุฏุฑุณุฉ', 'warning');
                return;
            }
            if (!password) {
                Swal.fire('ุชูุจูู', 'ูุฑุฌู ุฅุฏุฎุงู ููุฏ ุงููุฏุฑุณุฉ (ุงูุฑูู ุงูุณุฑู)', 'warning');
                return;
            }

            var selectedSchool = allSchoolsData.find(s => s.name === schoolName && s.type === schoolType);

            if (!selectedSchool) {
                Swal.fire('ุฎุทุฃ', 'ุจูุงูุงุช ุงููุฏุฑุณุฉ ุบูุฑ ุตุญูุญุฉ', 'error');
                return;
            }

            // Show loading
            const btn = document.querySelector('.login-btn');
            const originalText = btn.innerText;
            btn.innerText = "ุฌุงุฑู ุงูุฏุฎูู...";
            btn.disabled = true;

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "login",
                    schoolName: selectedSchool.name,
                    schoolType: selectedSchool.type,
                    password: password
                })
            })
                .then(res => res.json())
                .then(data => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                    if (data.status === "success") {
                        currentSchool = data.schoolData; // Has ID from Col E
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('dashboard-screen').style.display = 'block';

                        document.getElementById('ui-school-name').innerText = currentSchool.name;
                        document.getElementById('ui-school-type').innerText = currentSchool.type;
                        document.getElementById('print-school-name').innerText = currentSchool.name;
                        document.getElementById('school-type-display').innerText = currentSchool.type;

                        // Default to Grade 3
                        showGrade(3);
                    } else {
                        Swal.fire('ุฎุทุฃ', data.message, 'error');
                    }
                })
                .catch(err => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                    Swal.fire('ุฎุทุฃ', 'ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู', 'error');
                });
        }

        /* --- Admin Logic --- */
        function showAdminLogin() {
            document.getElementById('admin-login-modal').style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function submitAdminLogin() {
            const pass = document.getElementById('admin-pass-input').value;
            if (!pass) return;

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "adminLogin", password: pass })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        document.getElementById('admin-login-modal').style.display = 'none';
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('admin-dashboard-screen').style.display = 'block';
                        loadAdminStats(3);
                    } else {
                        Swal.fire('ุฎุทุฃ', 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ', 'error');
                    }
                });
        }

        function logout() {
            location.reload();
        }

        function logoutAdmin() {
            location.reload();
        }

        // --- Change Password Logic ---
        function showPasswordModal() {
            Swal.fire('ุชูุจูู', 'ูุฌุจ ุงูุฏุฎูู ูููุฏุฑุณุฉ ุฃููุงู ูุชุบููุฑ ูููุฉ ุงููุฑูุฑ ูู ุฏุงุฎู ุงูุชุฑุณ (ุณูุชู ุฅุถุงูุชู ูุงุญูุงู) ุฃู ุงูุชูุงุตู ูุน ุงููุณุคูู.', 'info');
            // For simplicity, we removed direct change pass from login screen to avoid complexity with lookup.
            // Or we can implement it similar to login.
            // Let's implement simpler:
            document.getElementById('password-modal').style.display = 'block';
            // But we need schoolName/Type... user has selected them in dropdown?
        }

        function changePassword() {
            var schoolType = document.getElementById('schoolTypeSelect').value;
            var schoolName = document.getElementById('schoolNameSelect').value;
            var newPass = document.getElementById('new-pass').value;

            if (!schoolType || !schoolName || !newPass) {
                Swal.fire('ุฎุทุฃ', 'ูุฑุฌู ุงุฎุชูุงุฑ ุงููุฏุฑุณุฉ ููุชุงุจุฉ ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ', 'error');
                return;
            }

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "changePassword",
                    schoolName: schoolName,
                    schoolType: schoolType,
                    newPass: newPass
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        Swal.fire('ุชู', 'ุชู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ', 'success');
                        closeModal('password-modal');
                    } else {
                        Swal.fire('ุฎุทุฃ', data.message, 'error');
                    }
                });
        }

        function validateNumberInput(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
        }

        // --- Dashboard Logic ---

        function showGrade(grade) {
            currentGrade = grade;
            const gradeText = grade == 3 ? 'ุงูุซุงูุซ' : grade == 4 ? 'ุงูุฑุงุจุน' : grade == 5 ? 'ุงูุฎุงูุณ' : 'ุงูุณุงุฏุณ';

            document.getElementById('grade-title').innerText = `ุงูุตู ${gradeText} ุงูุงุจุชุฏุงุฆู`;
            document.getElementById('print-title').innerText = `ุฅุญุตุงุก ูุชูุฌุฉ ุงูุชุญุงู ุงูุตู ${gradeText} ูุงูุชุญุงูุงุช ูุตู ุงูุนุงู 2025 / 2026 ู`;

            // Update active tab
            const dashboardTabs = document.querySelectorAll('#dashboard-screen .tabs .tab-btn');
            dashboardTabs.forEach(b => b.classList.remove('active'));
            if (dashboardTabs[grade - 3]) dashboardTabs[grade - 3].classList.add('active');

            const tbody = document.getElementById('subjects-body');
            tbody.innerHTML = "";

            subjectsConfig[grade].forEach((subj, index) => {
                let row = `
                <tr>
                    <td style="font-weight:bold; background-color: #fafafa;">${subj}</td>
                    <!-- Applied -->
                    <td><input type="number" id="app_b_${index}" class="sub-input" oninput="calcSubjRow(${index})"></td>
                    <td><input type="number" id="app_g_${index}" class="sub-input" oninput="calcSubjRow(${index})"></td>
                    <td id="app_t_${index}" style="background:#eee;">0</td>
                    
                    <!-- Present -->
                    <td><input type="number" id="pre_b_${index}" class="sub-input" oninput="calcSubjRow(${index})"></td>
                    <td><input type="number" id="pre_g_${index}" class="sub-input" oninput="calcSubjRow(${index})"></td>
                    <td id="pre_t_${index}" style="background:#eee;">0</td>

                    <!-- Success -->
                    <td><input type="number" id="suc_b_${index}" class="sub-input" oninput="calcSubjRow(${index})"></td>
                    <td><input type="number" id="suc_g_${index}" class="sub-input" oninput="calcSubjRow(${index})"></td>
                    <td id="suc_t_${index}" style="background:#eee;">0</td>

                    <td id="perc_${index}" style="font-weight:bold; direction:ltr;">0%</td>
                </tr>
                `;
                tbody.innerHTML += row;
            });

            loadSavedDataForGrade(grade);
        }

        // --- Calculation Logic ---

        function calcGenRow() {
            // 1. Get Core Values
            let enr_b = parseFloat(document.getElementById('enr_b').value) || 0;
            let enr_g = parseFloat(document.getElementById('enr_g').value) || 0;
            let pre_b = parseFloat(document.getElementById('pre_b').value) || 0;
            let pre_g = parseFloat(document.getElementById('pre_g').value) || 0;
            let suc_b = parseFloat(document.getElementById('suc_b').value) || 0;
            let suc_g = parseFloat(document.getElementById('suc_g').value) || 0;

            // 2. Auto-Calculate Derived Fields (As per user request)
            // Absent = Enrolled - Present
            let abs_b = Math.max(0, enr_b - pre_b);
            let abs_g = Math.max(0, enr_g - pre_g);
            document.getElementById('abs_b').value = abs_b;
            document.getElementById('abs_g').value = abs_g;

            // Fail (Less than 50%) = Present - Success
            let fail_b = Math.max(0, pre_b - suc_b);
            let fail_g = Math.max(0, pre_g - suc_g);
            document.getElementById('fail_b').value = fail_b;
            document.getElementById('fail_g').value = fail_g;

            // 3. Update Totals Display
            const fields = ['enr', 'pre', 'suc', 'fail', 'abs'];
            fields.forEach(f => {
                let b = parseFloat(document.getElementById(`${f}_b`).value) || 0;
                let g = parseFloat(document.getElementById(`${f}_g`).value) || 0;
                document.getElementById(`${f}_t`).innerText = b + g;
            });

            // Auto-fill Subject Applied Defaults from Enrolled?

            if (enr_b > 0 || enr_g > 0) {
                subjectsConfig[currentGrade].forEach((_, idx) => {
                    let ab = document.getElementById(`app_b_${idx}`);
                    let ag = document.getElementById(`app_g_${idx}`);

                    // FORCE UPDATE: As per user request, subject enrollment MUST match general enrollment.
                    ab.value = enr_b;
                    ag.value = enr_g;
                    calcSubjRow(idx);
                });
            }
        }

        function calcSubjRow(idx) {
            const getV = (id) => {
                let el = document.getElementById(id);
                return el ? (parseFloat(el.value) || 0) : 0;
            };
            const setT = (id, val) => {
                let el = document.getElementById(id);
                if (el) el.innerText = val;
            };

            let ab = getV(`app_b_${idx}`);
            let ag = getV(`app_g_${idx}`);
            setT(`app_t_${idx}`, ab + ag);

            let pb = getV(`pre_b_${idx}`);
            let pg = getV(`pre_g_${idx}`);
            setT(`pre_t_${idx}`, pb + pg);

            let sb = getV(`suc_b_${idx}`);
            let sg = getV(`suc_g_${idx}`);
            setT(`suc_t_${idx}`, sb + sg);

            let totalPre = pb + pg;
            let totalSuc = sb + sg;

            let perc = totalPre > 0 ? ((totalSuc / totalPre) * 100).toFixed(1) + "%" : "0%";
            setT(`perc_${idx}`, perc);
        }

        function saveData() {
            const check = (cond, msg) => { if (cond) throw new Error(msg); };
            const btn = document.querySelector('button[onclick="saveData()"]');

            try {
                const getVal = (id, label) => {
                    let el = document.getElementById(id);
                    if (!el) return 0;
                    if (el.value === "") throw new Error(`ุญูู ูุงุฑุบ: ${label} ูุฌุจ ุฅุฏุฎุงู ูููุฉ.`);
                    let v = parseFloat(el.value);
                    if (isNaN(v)) throw new Error(`ูููุฉ ุบูุฑ ุตุญูุญุฉ ูู ${label}`);
                    return v;
                };

                // Validate
                let gEnrB = getVal('enr_b', 'ุงููููุฏ ุจููู');
                let gEnrG = getVal('enr_g', 'ุงููููุฏ ุจูุงุช');
                let gPreB = getVal('pre_b', 'ุงูุญุงุถุฑ ุจููู');
                let gPreG = getVal('pre_g', 'ุงูุญุงุถุฑ ุจูุงุช');
                let gSucB = getVal('suc_b', 'ุงููุงุฌุญ ุจููู');
                let gSucG = getVal('suc_g', 'ุงููุงุฌุญ ุจูุงุช');

                check(gPreB > gEnrB, "ุนุฏุฏ ุงูุญุงุถุฑูู (ุจููู) ูุง ูููู ุฃู ูููู ุฃูุจุฑ ูู ุงููููุฏูู!");
                check(gPreG > gEnrG, "ุนุฏุฏ ุงูุญุงุถุฑูู (ุจูุงุช) ูุง ูููู ุฃู ูููู ุฃูุจุฑ ูู ุงููููุฏูู!");
                check(gSucB > gPreB, "ุนุฏุฏ ุงููุงุฌุญูู (ุจููู) ูุง ูููู ุฃู ูููู ุฃูุจุฑ ูู ุงูุญุงุถุฑูู!");
                check(gSucG > gPreG, "ุนุฏุฏ ุงููุงุฌุญูู (ุจูุงุช) ูุง ูููู ุฃู ูููู ุฃูุจุฑ ูู ุงูุญุงุถุฑูู!");

                subjectsConfig[currentGrade].forEach((subj, idx) => {
                    let appB = getVal(`app_b_${idx}`, `${subj} - ูููุฏ ุจููู`);
                    let appG = getVal(`app_g_${idx}`, `${subj} - ูููุฏ ุจูุงุช`);
                    let preB = getVal(`pre_b_${idx}`, `${subj} - ุญุงุถุฑ ุจููู`);
                    let preG = getVal(`pre_g_${idx}`, `${subj} - ุญุงุถุฑ ุจูุงุช`);
                    let sucB = getVal(`suc_b_${idx}`, `${subj} - 50% ูุฃูุซุฑ ุจููู`);
                    let sucG = getVal(`suc_g_${idx}`, `${subj} - 50% ูุฃูุซุฑ ุจูุงุช`);

                    check(preB > appB, `ูู ูุงุฏุฉ ${subj}: ุนุฏุฏ ุงูุญุงุถุฑูู (ุจููู) ุฃูุจุฑ ูู ุงููููุฏูู!`);
                    check(preG > appG, `ูู ูุงุฏุฉ ${subj}: ุนุฏุฏ ุงูุญุงุถุฑูู (ุจูุงุช) ุฃูุจุฑ ูู ุงููููุฏูู!`);
                    check(sucB > preB, `ูู ูุงุฏุฉ ${subj}: ุนุฏุฏ ุงูุญุงุตููู ุนูู 50% ูุฃูุซุฑ (ุจููู) ุฃูุจุฑ ูู ุงูุญุงุถุฑูู!`);
                    check(sucG > preG, `ูู ูุงุฏุฉ ${subj}: ุนุฏุฏ ุงูุญุงุตููู ุนูู 50% ูุฃูุซุฑ (ุจูุงุช) ุฃูุจุฑ ูู ุงูุญุงุถุฑูู!`);
                });

                if (btn) { btn.innerText = "ุฌุงุฑู ุงูุญูุธ..."; btn.disabled = true; }

            } catch (e) {
                Swal.fire('ุฎุทุฃ ูู ุงูุจูุงูุงุช', e.message, 'error');
                if (btn) { btn.disabled = false; btn.innerText = "๐พ ุญูุธ ุงูุจูุงูุงุช"; }
                return;
            }

            // Prepare Data
            const getV = (id) => document.getElementById(id).value || 0;
            const getT = (id) => document.getElementById(id).innerText || 0;
            let stats = [];

            stats.push(1); // Count
            let enrT = getT('enr_t');
            stats.push(getV('enr_b'), getV('enr_g'), enrT);
            stats.push(getV('pre_b'), getV('pre_g'), getT('pre_t'));
            stats.push(getV('suc_b'), getV('suc_g'), getT('suc_t'));
            stats.push(getV('fail_b'), getV('fail_g'), getT('fail_t'));
            stats.push(getV('abs_b'), getV('abs_g'), getT('abs_t'));
            stats.push(enrT); // Redundant

            subjectsConfig[currentGrade].forEach((_, idx) => {
                let pb = parseFloat(getV(`pre_b_${idx}`)) || 0;
                let pg = parseFloat(getV(`pre_g_${idx}`)) || 0;
                let totalPre = pb + pg;
                let sb = parseFloat(getV(`suc_b_${idx}`)) || 0;
                let sg = parseFloat(getV(`suc_g_${idx}`)) || 0;
                let totalSuc = sb + sg;
                let totalLess = Math.max(0, totalPre - totalSuc);
                stats.push(totalPre, totalSuc, totalLess);
            });

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "saveStats",
                    grade: currentGrade,
                    schoolId: currentSchool.id,
                    schoolName: currentSchool.name,
                    schoolType: currentSchool.type,
                    statsData: stats
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (btn) { btn.disabled = false; btn.innerText = "๐พ ุญูุธ ุงูุจูุงูุงุช"; }
                    if (data.status === "success") {
                        Swal.fire('ุชู ุงูุญูุธ!', data.message, 'success');
                    } else {
                        Swal.fire('ุฎุทุฃ', data.message || "ุญุฏุซ ุฎุทุฃ", 'error');
                    }
                })
                .catch(err => {
                    if (btn) { btn.disabled = false; btn.innerText = "๐พ ุญูุธ ุงูุจูุงูุงุช"; }
                    Swal.fire('ุฎุทุฃ', 'ูุดู ุงูุญูุธ: ' + err.message, 'error');
                });
        }

        function exportToExcel() {
            try {
                if (!currentSchool) {
                    Swal.fire('ุชูุจูู', 'ุจุฑุฌุงุก ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู', 'info');
                    return;
                }
                const getV = (id) => {
                    let el = document.getElementById(id);
                    return el ? (el.value || "0") : "0";
                };
                const getT = (id) => {
                    let el = document.getElementById(id);
                    return el ? (el.innerText || "0") : "0";
                };

                const subjects = subjectsConfig[currentGrade] || [];
                if (subjects.length === 0) {
                    Swal.fire('ุฎุทุฃ', 'ูุง ุชูุฌุฏ ุชููุฆุฉ ููููุงุฏ ููุฐุง ุงูุตู: ' + currentGrade, 'error');
                    return;
                }

                let rows = [
                    ["ูุญุงูุธุฉ ุงูุฌูุฒุฉ - ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ"],
                    ["ูุฏูุฑูุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู - ุงูุชุนููู ุงูุงุจุชุฏุงุฆู"],
                    [`ูุฏุฑุณุฉ: ${currentSchool.name || 'ุบูุฑ ูุนุฑูู'}`],
                    [`ุจูุงู ุฅุญุตุงุฆู - ุงูุตู ${currentGrade} ุงูุงุจุชุฏุงุฆู - ูุตู ุงูุนุงู 2026`],
                    [""],
                    ["ุฃููุงู: ุงูุฅุญุตุงุก ุงูุนุงู"],
                    ["ููุน ุงูุชุนููู", "ุงููููุฏ ุจููู", "ุงููููุฏ ุจูุงุช", "ุงููููุฏ ุฌููุฉ", "ุงูุญุงุถุฑ ุจููู", "ุงูุญุงุถุฑ ุจูุงุช", "ุงูุญุงุถุฑ ุฌููุฉ", "ุงููุงุฌุญ ุจููู", "ุงููุงุฌุญ ุจูุงุช", "ุงููุงุฌุญ ุฌููุฉ", "ุงูุฑุงุณุจ ุจููู", "ุงูุฑุงุณุจ ุจูุงุช", "ุงูุฑุงุณุจ ุฌููุฉ", "ุงูุบุงุฆุจ ุจููู", "ุงูุบุงุฆุจ ุจูุงุช", "ุงูุบุงุฆุจ ุฌููุฉ"],
                    [
                        currentSchool.type || "-",
                        getV('enr_b'), getV('enr_g'), getT('enr_t'),
                        getV('pre_b'), getV('pre_g'), getT('pre_t'),
                        getV('suc_b'), getV('suc_g'), getT('suc_t'),
                        getV('fail_b'), getV('fail_g'), getT('fail_t'),
                        getV('abs_b'), getV('abs_g'), getT('abs_t')
                    ],
                    [""],
                    ["ุซุงููุงู: ุฅุญุตุงุก ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ"]
                ];

                let subjectsRow = ["ุงููุงุฏุฉ"];
                let subHeadRow = [""];
                subjects.forEach((subj) => {
                    subjectsRow.push(subj, "", "");
                    subHeadRow.push("ุญุงุถุฑ", "ูุงุฌุญ", "ุฑุงุณุจ");
                });
                rows.push(subjectsRow, subHeadRow);

                let dataRow = [currentSchool.type || "-"];
                subjects.forEach((_, idx) => {
                    dataRow.push(getT(`pre_t_${idx}`), getT(`suc_t_${idx}`), getT(`fail_t_${idx}`));
                });
                rows.push(dataRow);

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(rows);

                // --- Add Borders to All Cells ---
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        let cell_address = { c: C, r: R };
                        let cell_ref = XLSX.utils.encode_cell(cell_address);
                        if (!ws[cell_ref]) continue;
                        ws[cell_ref].s = {
                            border: {
                                top: { style: "thin", color: { rgb: "000000" } },
                                bottom: { style: "thin", color: { rgb: "000000" } },
                                left: { style: "thin", color: { rgb: "000000" } },
                                right: { style: "thin", color: { rgb: "000000" } }
                            },
                            alignment: { vertical: "center", horizontal: "center" }
                        };
                    }
                }

                ws['!cols'] = [{ wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 10 }];

                XLSX.utils.book_append_sheet(wb, ws, "Stats");
                XLSX.writeFile(wb, `Report_${currentSchool.name}_G${currentGrade}.xlsx`);
                Toast.fire({ icon: 'success', title: 'ุชู ุชุญููู ููู Excel' });
            } catch (e) {
                console.error("Excel Export Error:", e);
                Swal.fire('ุฎุทุฃ', 'ูุดู ุชุตุฏูุฑ Excel: ' + e.message, 'error');
            }
        }

        function prepareOfficialPrint() {
            try {
                console.log("Preparing Individual Print...");
                const getV = (id) => parseFloat(document.getElementById(id).value) || 0;
                const getT = (id) => parseFloat(document.getElementById(id).innerText) || 0;

                const subjects = subjectsConfig[currentGrade];
                const subjStats = [];
                subjects.forEach((_, idx) => {
                    let pre = getT(`pre_t_${idx}`);
                    let suc = getT(`suc_t_${idx}`);
                    subjStats.push(pre, suc, Math.max(0, pre - suc));
                });

                const data = {
                    enrolledB: getV('enr_b'), enrolledG: getV('enr_g'), enrolledT: getT('enr_t'),
                    presentB: getV('pre_b'), presentG: getV('pre_g'), presentT: getT('pre_t'),
                    successB: getV('suc_b'), successG: getV('suc_g'), successT: getT('suc_t'),
                    failB: getV('fail_b'), failG: getV('fail_g'), failT: getT('fail_t'),
                    absentB: getV('abs_b'), absentG: getV('abs_g'), absentT: getT('abs_t'),
                    subjectStats: subjStats
                };

                renderAdminTables(data, currentGrade, true);

                if (typeof printJS === 'function') {
                    printJS({
                        printable: 'school-print-area',
                        type: 'html',
                        targetStyles: ['*'],
                        style: `
                            @page { size: A4 landscape; margin: 10mm; } 
                            body { direction: rtl; font-family: 'Arial', sans-serif; } 
                            .admin-table-official { width: 100% !important; border-collapse: collapse !important; border: 2px solid #000 !important; }
                            .admin-table-official th, .admin-table-official td { border: 1px solid #000 !important; padding: 4px !important; text-align: center !important; }
                        `,
                        scanStyles: true
                    });
                } else {
                    console.warn("Print.js not loaded, falling back to window.print");
                    document.body.classList.add('printing-school');
                    window.print();
                    document.body.classList.remove('printing-school');
                }
            } catch (e) {
                console.error("Print Error:", e);
                Swal.fire('ุฎุทุฃ ูู ุงูุทุจุงุนุฉ', e.message, 'error');
            }
        }

        function printAdminReport() {
            try {
                const source = document.getElementById('admin-view-reports');
                if (!source || !source.innerHTML) {
                    Swal.fire('ุชูุจูู', 'ูุง ุชูุฌุฏ ุจูุงูุงุช ููุนุฑุถุ ูุฑุฌู ุงุฎุชูุงุฑ ุงูุตู ุฃููุงู', 'info');
                    return;
                }

                if (typeof printJS === 'function') {
                    printJS({
                        printable: 'admin-view-reports',
                        type: 'html',
                        targetStyles: ['*'],
                        style: `
                            @page { size: A4 landscape; margin: 10mm; } 
                            body { direction: rtl; font-family: 'Arial', sans-serif; } 
                            .admin-table-official { width: 100% !important; border-collapse: collapse !important; border: 2px solid #000 !important; }
                            .admin-table-official th, .admin-table-official td { border: 1px solid #000 !important; padding: 4px !important; text-align: center !important; }
                        `,
                        scanStyles: true
                    });
                } else {
                    console.warn("Print.js not loaded, falling back to window.print");
                    const target = document.getElementById('school-print-area');
                    target.innerHTML = source.innerHTML;
                    document.body.classList.add('printing-school');
                    window.print();
                    document.body.classList.remove('printing-school');
                    target.innerHTML = "";
                }
            } catch (e) {
                console.error("Admin Print Error:", e);
                Swal.fire('ุฎุทุฃ ูู ุทุจุงุนุฉ ุงูุฅุฏุงุฑุฉ', e.message, 'error');
            }
        }

        function loadSavedDataForGrade(grade) {
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "getSchoolStats",
                    grade: grade,
                    schoolId: currentSchool.id // Unique Code from Col E
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success" && data.hasData) {
                        populateFormWithData(data.statsData, grade);
                        Toast.fire({ icon: 'success', title: 'ุชู ุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช ุงููุญููุธุฉ' });
                    }
                })
                .catch(err => console.log(err));
        }

        // --- Render Admin/School Tables (Official Two-Table Layout matching Images) ---
        let lastAdminData = null;

        function renderAdminTables(data, grade, isIndividual = false) {
            try {
                if (!isIndividual) lastAdminData = data;

                const adminArea = isIndividual ? document.getElementById('school-print-area') : document.getElementById('admin-view-reports');
                if (!adminArea) return;

                adminArea.innerHTML = "";
                const subjects = subjectsConfig[grade];

                const types = isIndividual ? ["target"] : ["ุฑุณูู ุนุฑุจู", "ุฑุณูู ูุบุงุช", "ุฎุงุต ุนุฑุจู", "ุฎุงุต ูุบุงุช", "ุฏููู", "ูุฌููุน"];
                const typeLabels = {
                    "ุฑุณูู ุนุฑุจู": "ูุฏุงุฑุณ ุฑุณูู ุนุฑุจู", "ุฑุณูู ูุบุงุช": "ูุฏุงุฑุณ ุฑุณูู ูุบุงุช",
                    "ุฎุงุต ุนุฑุจู": "ูุฏุงุฑุณ ุฎุงุต ุนุฑุจู", "ุฎุงุต ูุบุงุช": "ูุฏุงุฑุณ ุฎุงุต ูุบุงุช",
                    "ุฏููู": "ูุฏุงุฑุณ ุฏููู", "ูุฌููุน": "ุงูุฅุฌูุงูู",
                    "target": currentSchool ? currentSchool.name : "ุงููุฏุฑุณุฉ"
                };
                const typeLabels2 = {
                    "ุฑุณูู ุนุฑุจู": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฑุณููุฉ ุนุฑุจู", "ุฑุณูู ูุบุงุช": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฑุณููุฉ ูุบุงุช",
                    "ุฎุงุต ุนุฑุจู": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฎุงุตุฉ ุนุฑุจู", "ุฎุงุต ูุบุงุช": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฎุงุตุฉ ูุบุงุช",
                    "ุฏููู": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฏูููุฉ", "ูุฌููุน": "ุงูุฌููุฉ ุงูุนุงูุฉ ููุฅุฏุงุฑุฉ",
                    "target": currentSchool ? currentSchool.name : "ุงููุฏุฑุณุฉ"
                };

                let html = `<div class="admin-sheet-container">`;

                const headerHtml = (formNum) => `
                    <div class="print-header-container" style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                        <div style="flex:1; text-align:right; font-size:12px; line-height:1.4; font-weight:bold;">
                            ูุญุงูุธุฉ ุงูุฌูุฒุฉ <br> ูุฏูุฑูุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู <br> ุงูุชุนููู ุงูุงุจุชุฏุงุฆู
                        </div>
                        <div style="flex:2; text-align:center;">
                            <div style="font-weight:bold; font-size:1.1rem; text-decoration:underline;">
                                ุจูุงู ุฅุญุตุงุฆู ${grade == 3 ? 'ุงูุตู ุงูุซุงูุซ' : grade == 4 ? 'ุงูุตู ุงูุฑุงุจุน' : grade == 5 ? 'ุงูุตู ุงูุฎุงูุณ' : 'ุงูุตู ุงูุณุงุฏุณ'} ุงูุงุจุชุฏุงุฆู
                            </div>
                            <div style="font-weight:bold; font-size:1.2rem; margin-top:5px;">ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ</div>
                            ${isIndividual && currentSchool ? `<div style="font-weight:bold; font-size:1.1rem; margin-top:5px;">ูุฏุฑุณุฉ / ${currentSchool.name}</div>` : ''}
                            <div style="margin-top:5px; font-size:12px;">ุนู ุงูุชุญุงู ูุตู ุงูุนุงู ุงูุฏุฑุงุณู 2025 / 2026</div>
                            <div style="font-size:11px; margin-top:5px; font-weight:bold;">ุงุณุชูุงุฑุฉ ุฑูู ( ${formNum} )</div>
                        </div>
                        <div style="flex:1; text-align:left;">
                            <img src="logo.jpg" style="height:70px; width:auto;" alt="Logo" onerror="this.style.display='none'">
                        </div>
                    </div>
                `;

                // --- TABLE 1: GENERAL STATS ---
                html += headerHtml('1');
                html += `
                    <style>
                        .admin-table-official {
                            width: 100% !important;
                            border-collapse: collapse !important;
                            border: 2px solid #000 !important;
                            margin-bottom: 20px;
                        }
                        .admin-table-official th, .admin-table-official td {
                            border: 1px solid #000 !important;
                            min-width: 32px !important;
                            padding: 4px 2px !important;
                            font-size: 10pt !important;
                            white-space: nowrap !important;
                            text-align: center;
                        }
                        .admin-table-official .col-label {
                            min-width: 150px !important;
                            text-align: right;
                            padding-right: 10px !important;
                            white-space: normal !important;
                            font-weight: bold;
                        }
                    </style>
                    <table class="admin-table-official">
                        <thead>
                            <tr>
                                <th rowspan="2">ููุน ุงูุชุนููู</th>
                                <th rowspan="2" style="min-width:40px !important;">ุงููุฏุงุฑุณ</th>
                                <th colspan="3">ุงููููุฏ</th>
                                <th colspan="3">ุงูุญุงุถุฑ</th>
                                <th colspan="3">ุงููุงุฌุญ (50% ูุฃูุซุฑ)</th>
                                <th colspan="3">ุงูุฑุงุณุจ (ุฃูู ูู 50%)</th>
                                <th colspan="3">ุงูุบุงุฆุจ</th>
                            </tr>
                            <tr>
                                <th>ุจููู</th><th>ุจูุงุช</th><th>ุฌููุฉ</th>
                                <th>ุจููู</th><th>ุจูุงุช</th><th>ุฌููุฉ</th>
                                <th>ุจููู</th><th>ุจูุงุช</th><th>ุฌููุฉ</th>
                                <th>ุจููู</th><th>ุจูุงุช</th><th>ุฌููุฉ</th>
                                <th>ุจููู</th><th>ุจูุงุช</th><th>ุฌููุฉ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let statsSource = isIndividual ? { "target": data } : (data ? data.stats : {});
                types.forEach(type => {
                    let d = statsSource[type] || {};
                    const v = (k) => d[k] || 0;
                    html += `<tr>
                        <td class="col-label">${typeLabels[type]}</td>
                        <td>${isIndividual ? '1' : (v('schoolsCount') || '')}</td>
                        <td>${v('enrolledB')}</td><td>${v('enrolledG')}</td><td>${v('enrolledT')}</td>
                        <td>${v('presentB')}</td><td>${v('presentG')}</td><td>${v('presentT')}</td>
                        <td>${v('successB')}</td><td>${v('successG')}</td><td>${v('successT')}</td>
                        <td>${v('failB')}</td><td>${v('failG')}</td><td>${v('failT')}</td>
                        <td>${v('absentB')}</td><td>${v('absentG')}</td><td>${v('absentT')}</td>
                    </tr>`;
                });

                html += `</tbody></table>`;
                html += `<div style="height:25px;"></div>`;

                // --- TABLE 2: SUBJECT STATS ---
                html += `<h4 style="text-align:center; margin-bottom:10px; text-decoration:underline; font-size:1.2rem;">ุซุงููุงู: ุฅุญุตุงุก ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ</h4>`;
                html += `
                    <table class="admin-table-official">
                        <thead>
                            <tr>
                                <th rowspan="2" class="col-label">ููุนูุฉ ุงูุชุนููู</th>
                                <th rowspan="2" style="min-width:50px !important;">ุงููููุฏ</th>
                                ${subjects.map(s => `<th colspan="3">${s}</th>`).join('')}
                            </tr>
                            <tr>
                                ${subjects.map(() => `<th>ุญุงุถุฑ</th><th>ูุงุฌุญ</th><th>ุฑุงุณุจ</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;

                types.forEach(type => {
                    let d = statsSource[type] || {};
                    let enrollmentTotal = d.enrolledT || 0;
                    let subjStats = d.subjectStats || [];
                    html += `<tr>
                        <td style="text-align:right; padding-right:10px; font-weight:bold;">${isIndividual ? typeLabels[type] : typeLabels2[type]}</td>
                        <td style="background:#f9f9f9; font-weight:bold;">${enrollmentTotal}</td>
                        ${subjects.map((_, idx) => {
                        let b = idx * 3;
                        return `<td>${subjStats[b] || 0}</td><td>${subjStats[b + 1] || 0}</td><td>${subjStats[b + 2] || 0}</td>`;
                    }).join('')}
                    </tr>`;
                });

                html += `</tbody></table>`;

                // SIGS
                html += `
                    <div style="display:flex; justify-content:space-around; margin-top:35px; font-weight:bold;">
                        <div style="text-align:center;">
                            <div>${isIndividual ? 'ุฑุฆูุณ ูุฌูุฉ ุงููุธุงู ูุงููุฑุงูุจุฉ' : 'ูุฏูุฑ ุงููุฑุญูุฉ'}</div>
                            <div style="margin-top:45px; border-top:1.5px solid #000; min-width:180px;">ุงูุงุณู ูุงูุชูููุน</div>
                        </div>
                        <div style="text-align:center;">
                            <div>${isIndividual ? 'ูุฏูุฑ ุงููุฏุฑุณุฉ' : 'ูุฏูุฑ ุนุงู ุงูุฅุฏุงุฑุฉ'}</div>
                            <div style="margin-top:45px; border-top:1.5px solid #000; min-width:180px;">ุงูุงุณู ูุงูุชูููุน</div>
                        </div>
                    </div>
                </div>`;

                adminArea.innerHTML = html;

                if (!isIndividual && data) {
                    // Update status view
                    const listSub = document.getElementById('list-submitted');
                    const listMis = document.getElementById('list-missing');
                    if (listSub && listMis) {
                        listSub.innerHTML = ""; listMis.innerHTML = "";
                        const sub = data.submittedSchools || [];
                        const mis = data.missingSchools || [];
                        const subCount = document.getElementById('count-submitted');
                        const misCount = document.getElementById('count-missing');
                        if (subCount) subCount.innerText = sub.length;
                        if (misCount) misCount.innerText = mis.length;
                        sub.forEach(s => listSub.innerHTML += `<li>โ ${s.name || s}</li>`);
                        mis.forEach(s => listMis.innerHTML += `<li>โ ${s.name || s}</li>`);
                    }
                }
            } catch (e) {
                console.error("Render Error:", e);
            }
        }

        // --- Load Saved Data (Populate Input Form) ---
        function populateFormWithData(data, grade) {
            if (!data || data.length < 16) return;

            const setV = (id, val) => {
                let el = document.getElementById(id);
                if (el) el.value = val;
            };

            // 1. General Stats
            setV('enr_b', data[1]); setV('enr_g', data[2]);
            setV('pre_b', data[4]); setV('pre_g', data[5]);
            setV('suc_b', data[7]); setV('suc_g', data[8]);
            setV('fail_b', data[10]); setV('fail_g', data[11]);
            setV('abs_b', data[13]); setV('abs_g', data[14]);
            calcGenRow();

            // 2. Subjects (Saved as Totals: Present, Success, Less)
            let enrB = parseFloat(data[1]) || 0;
            let enrG = parseFloat(data[2]) || 0;
            let isGirls = (enrB === 0 && enrG > 0);

            subjectsConfig[grade].forEach((_, idx) => {
                let base = 17 + (idx * 3);
                if (!data[base]) return;

                let totPre = parseFloat(data[base]) || 0;
                let totSuc = parseFloat(data[base + 1]) || 0;

                if (isGirls) {
                    setV(`pre_g_${idx}`, totPre); setV(`pre_b_${idx}`, 0);
                    setV(`suc_g_${idx}`, totSuc); setV(`suc_b_${idx}`, 0);
                    setV(`app_g_${idx}`, enrG); setV(`app_b_${idx}`, 0);
                } else {
                    setV(`pre_b_${idx}`, totPre); setV(`pre_g_${idx}`, 0);
                    setV(`suc_b_${idx}`, totSuc); setV(`suc_g_${idx}`, 0);
                    setV(`app_b_${idx}`, enrB); setV(`app_g_${idx}`, enrG);
                }
                calcSubjRow(idx);
            });

            Toast.fire({
                icon: 'info',
                title: 'ุชู ุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช',
                text: 'ุชู ุชูุฒูุน ุฅุฌูุงููุงุช ุงูููุงุฏ ุจูุงุกู ุนูู ููุน ุงููุฏุฑุณุฉ.'
            });
        }

        // --- Admin Dashboard (Load Stats) ---
        function switchAdminView(view) {
            document.getElementById('admin-view-reports').style.display = 'none';
            document.getElementById('admin-view-status').style.display = 'none';
            document.getElementById('btn-view-reports').classList.remove('active');
            document.getElementById('btn-view-status').classList.remove('active');

            if (view === 'reports') {
                document.getElementById('admin-view-reports').style.display = 'block';
                document.getElementById('btn-view-reports').classList.add('active');
            } else {
                document.getElementById('admin-view-status').style.display = 'block';
                document.getElementById('btn-view-status').classList.add('active');
            }
        }

        function loadAdminStats(grade) {
            try {
                // debug
                console.log("Loading Admin Stats for Grade:", grade);

                currentGrade = grade; // Update global grade for export

                // Update Titles
                let gradeTitle = "unknown";
                if (grade == 3) gradeTitle = "3 ุงุจุชุฏุงุฆู";
                else if (grade == 4) gradeTitle = "4 ุงุจุชุฏุงุฆู";
                else if (grade == 5) gradeTitle = "5 ุงุจุชุฏุงุฆู";
                else if (grade == 6) gradeTitle = "6 ุงุจุชุฏุงุฆู";

                const titleEl = document.getElementById('admin-grade-title');
                if (titleEl) titleEl.innerText = gradeTitle;

                const printTitleEl = document.getElementById('admin-print-title');
                if (printTitleEl) printTitleEl.innerText = `ุฅุญุตุงุก ุงูุตู ${grade} ุงูุงุจุชุฏุงุฆู`;

                // Highlight Active Tab
                const allButtons = document.querySelectorAll('#admin-dashboard-screen .tabs button');
                allButtons.forEach(btn => btn.classList.remove('active'));

                // Find and highlight the button that was clicked (based on text or onclick)
                // Since we can't easily identify which button was clicked without passing 'this', 
                // we will try to find it by text content or index.
                // Simplified: Just match index 0-3
                if (allButtons[grade - 3]) {
                    allButtons[grade - 3].classList.add('active');
                }

                Swal.showLoading();
                fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "getAdminStats", grade: grade })
                })
                    .then(res => res.json())
                    .then(data => {
                        Swal.close();
                        if (data.status === "success") {
                            switchAdminView('reports');
                            renderAdminTables(data.aggregation, grade);
                        } else {
                            Swal.fire('ุฎุทุฃ', data.message || "ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุนุฑูู", 'error');
                        }
                    })
                    .catch(err => {
                        Swal.close();
                        console.error(err);
                        Swal.fire('ุฎุทุฃ', 'ูุดู ูู ุฌูุจ ุงูุจูุงูุงุช: ' + err.message, 'error');
                    });

            } catch (e) {
                console.error(e);
                Swal.fire('Error', e.message, 'error');
            }
        }

        function exportAdminToExcel() {
            if (!lastAdminData) {
                Swal.fire('ุฎุทุฃ', 'ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุตุฏูุฑูุง. ูุฑุฌู ุชุญููู ุงูุฌุฏูู ุฃููุงู.', 'warning');
                return;
            }

            const grade = currentGrade;
            const subjects = subjectsConfig[grade];
            const types = ["ุฑุณูู ุนุฑุจู", "ุฑุณูู ูุบุงุช", "ุฎุงุต ุนุฑุจู", "ุฎุงุต ูุบุงุช", "ุฏููู", "ูุฌููุน"];
            const typeLabels = {
                "ุฑุณูู ุนุฑุจู": "ูุฏุงุฑุณ ุฑุณูู ุนุฑุจู", "ุฑุณูู ูุบุงุช": "ูุฏุงุฑุณ ุฑุณูู ูุบุงุช",
                "ุฎุงุต ุนุฑุจู": "ูุฏุงุฑุณ ุฎุงุต ุนุฑุจู", "ุฎุงุต ูุบุงุช": "ูุฏุงุฑุณ ุฎุงุต ูุบุงุช",
                "ุฏููู": "ูุฏุงุฑุณ ุฏููู", "ูุฌููุน": "ุงูุฅุฌูุงูู"
            };
            const typeLabels2 = {
                "ุฑุณูู ุนุฑุจู": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฑุณููุฉ ุนุฑุจู", "ุฑุณูู ูุบุงุช": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฑุณููุฉ ูุบุงุช",
                "ุฎุงุต ุนุฑุจู": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฎุงุตุฉ ุนุฑุจู", "ุฎุงุต ูุบุงุช": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฎุงุตุฉ ูุบุงุช",
                "ุฏููู": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฏูููุฉ", "ูุฌููุน": "ุงูุฌููุฉ ุงูุนุงูุฉ ููุฅุฏุงุฑุฉ"
            };

            const wb = XLSX.utils.book_new();

            // --- General Stats (Sheet 1) ---
            const genRows = [];
            genRows.push(["ุจูุงู ุฅุญุตุงุฆู ( ุงุณุชูุงุฑุฉ 1 ) - ุงูุตู " + grade + " ุงูุงุจุชุฏุงุฆู - ูุตู ุงูุนุงู 2026"]);
            genRows.push(["ููุน ุงูุชุนููู", "ุนุฏุฏ ุงููุฏุงุฑุณ", "ุงููููุฏ", "", "", "ุงูุญุงุถุฑ", "", "", "50% ูุฃูุซุฑ", "", "", "ุฃูู ูู 50 %", "", "", "ุงูุบุงุฆุจ", "", ""]);
            genRows.push(["", "", "ุจููู", "ุจูุงุช", "ุฌููุฉ", "ุจููู", "ุจูุงุช", "ุฌููุฉ", "ุจููู", "ุจูุงุช", "ุฌููุฉ", "ุจููู", "ุจูุงุช", "ุฌููุฉ", "ุจููู", "ุจูุงุช", "ุฌููุฉ"]);

            types.forEach(type => {
                let d = lastAdminData.stats[type] || {};
                const v = (k) => d[k] || 0;
                genRows.push([
                    typeLabels[type], (type === "ูุฌููุน" ? "" : v('schoolsCount')),
                    v('enrolledB'), v('enrolledG'), v('enrolledT'),
                    v('presentB'), v('presentG'), v('presentT'),
                    v('successB'), v('successG'), v('successT'),
                    v('failB'), v('failG'), v('failT'),
                    v('absentB'), v('absentG'), v('absentT')
                ]);
            });

            const wsGen = XLSX.utils.aoa_to_sheet(genRows);
            wsGen['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 16 } },
                { s: { r: 1, c: 0 }, e: { r: 2, c: 0 } },
                { s: { r: 1, c: 1 }, e: { r: 2, c: 1 } },
                { s: { r: 1, c: 2 }, e: { r: 1, c: 4 } },
                { s: { r: 1, c: 5 }, e: { r: 1, c: 7 } },
                { s: { r: 1, c: 8 }, e: { r: 1, c: 10 } },
                { s: { r: 1, c: 11 }, e: { r: 1, c: 13 } },
                { s: { r: 1, c: 14 }, e: { r: 1, c: 16 } }
            ];
            // XLSX.utils.book_append_sheet(wb, wsGen, "ุฅุญุตุงุก ุนุงู (1)"); // Moved after styling

            // --- Subject Stats (Sheet 2) ---
            const subjRows = [];
            subjRows.push(["ุจูุงู ุฅุญุตุงุฆู ( ุงุณุชูุงุฑุฉ 2 ) - ุงูุตู " + grade + " ุงูุงุจุชุฏุงุฆู"]);
            const head1 = ["ููุนูุฉ ุงูุชุนููู", "ุงููููุฏ"];
            subjects.forEach(s => { head1.push(s, "", ""); });
            subjRows.push(head1);
            const head2 = ["", ""];
            subjects.forEach(() => { head2.push("ุญุงุถุฑ", "ุงูุซุฑ", "ุงูู"); });
            subjRows.push(head2);

            types.forEach(type => {
                let d = lastAdminData.stats[type] || {};
                let enrollmentTotal = d.enrolledT || 0;
                let subjStats = d.subjectStats || [];
                const row = [typeLabels2[type], enrollmentTotal];
                subjects.forEach((_, idx) => {
                    let base = idx * 3;
                    row.push(subjStats[base] || 0, subjStats[base + 1] || 0, subjStats[base + 2] || 0);
                });
                subjRows.push(row);
            });

            const wsSubj = XLSX.utils.aoa_to_sheet(subjRows);
            const subjMerges = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 2 + subjects.length * 3 - 1 } }];
            subjMerges.push({ s: { r: 1, c: 0 }, e: { r: 2, c: 0 } });
            subjMerges.push({ s: { r: 1, c: 1 }, e: { r: 2, c: 1 } });
            subjects.forEach((_, i) => {
                let startCol = 2 + (i * 3);
                subjMerges.push({ s: { r: 1, c: startCol }, e: { r: 1, c: startCol + 2 } });
            });
            wsSubj['!merges'] = subjMerges;

            // --- Apply Borders to both Admin Sheets ---
            [wsGen, wsSubj].forEach(ws => {
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        let cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
                        if (!ws[cell_ref]) ws[cell_ref] = { t: 's', v: '' }; // Ensure cell exists
                        ws[cell_ref].s = {
                            border: {
                                top: { style: "thin" }, bottom: { style: "thin" },
                                left: { style: "thin" }, right: { style: "thin" }
                            },
                            alignment: { vertical: "center", horizontal: "center", wrapText: true }
                        };
                        // Bold Headers
                        if (R < 3) ws[cell_ref].s.font = { bold: true };
                    }
                }
            });

            XLSX.utils.book_append_sheet(wb, wsGen, "ุฅุญุตุงุก ุนุงู (1)");
            XLSX.utils.book_append_sheet(wb, wsSubj, "ุฅุญุตุงุก ุงูููุงุฏ (2)");

            XLSX.writeFile(wb, `GizaStats_Grade${grade}.xlsx`);
        }

    </script>
</body>


</html>
