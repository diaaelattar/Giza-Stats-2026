<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ููุธููุฉ ุงูุฅุญุตุงุก - ูุญุงูุธุฉ ุงูุฌูุฒุฉ</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">

</head>

<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-card">
            <img src="logo.jpg" alt="Logo" style="width: 60px; margin-bottom: 15px;">
            <h2>ูุญุงูุธุฉ ุงูุฌูุฒุฉ</h2>
            <h3>ููุธููุฉ ุฅุญุตุงุก ุงูุชุนููู ุงูุงุจุชุฏุงุฆู</h3>

            <!-- Dynamic Dropdowns -->
            <div id="loading-schools" style="margin: 20px 0; color: #666;">ุฌุงุฑู ุชุญููู ูุงุฆูุฉ ุงููุฏุงุฑุณ...</div>

            <div id="login-form-area" style="display: none; width: 100%;">
                <select id="schoolTypeSelect" onchange="filterSchools()">
                    <option value="">ุงุฎุชุฑ ููุน ุงูุชุนููู...</option>
                </select>

                <select id="schoolNameSelect">
                    <option value="">ุงุฎุชุฑ ุงููุฏุฑุณุฉ...</option>
                </select>

                <input type="password" id="schoolCode" placeholder="ููุฏ ุงููุฏุฑุณุฉ (ุงูุฑูู ุงูุณุฑู)">
                <button class="login-btn" onclick="login()">ุชุณุฌูู ุงูุฏุฎูู</button>

                <div style="margin-top: 15px;">
                    <a href="#" onclick="showPasswordModal()"
                        style="font-size: 0.9rem; color: var(--primary-color); text-decoration: none;">ุชุบููุฑ ูููุฉ
                        ุงููุฑูุฑ</a>
                    <span style="color:#ccc; margin:0 5px;">|</span>
                    <a href="#" onclick="showAdminLogin()"
                        style="font-size: 0.9rem; color: #e74c3c; text-decoration: none;">ุฏุฎูู ุงููุณุคูู (Admin)</a>
                </div>
            </div>
        </div>
        <div class="copyright-footer" style="background: transparent; border: none; font-size: 0.8rem;">
            ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ 2026 &copy; <br>
            ุชุทููุฑ: <span style="font-family: sans-serif; font-weight: bold;">Diaa El Attar</span>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="modal">
        <div class="modal-content" style="border-top: 5px solid #e74c3c;">
            <h3 style="color: #e74c3c;">ุฏุฎูู ุงููุณุคูู</h3>
            <input type="password" id="admin-pass-input" placeholder="ูููุฉ ูุฑูุฑ ุงููุณุคูู">
            <button class="modal-btn" style="background: #e74c3c; color: white;"
                onclick="submitAdminLogin()">ุฏุฎูู</button>
            <button class="modal-btn" style="background: #7f8c8d; color: white;"
                onclick="closeModal('admin-login-modal')">ุฅูุบุงุก</button>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--primary-color);">ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</h3>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">ุงุฎุชุฑ ุงููุฏุฑุณุฉ ูู ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ ุฃููุงู</p>

            <input type="password" id="old-pass" placeholder="ูููุฉ ุงููุฑูุฑ ุงููุฏููุฉ">
            <input type="text" id="new-pass" placeholder="ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ (ุฃุฑูุงู ููุท)"
                oninput="validateNumberInput(this)">

            <div style="margin-top: 15px;">
                <button class="modal-btn" style="background: var(--primary-color); color: white;"
                    onclick="changePassword()">ุญูุธ ุงูุชุบููุฑ</button>
                <button class="modal-btn" style="background: #e74c3c; color: white;"
                    onclick="closeModal('password-modal')">ุฅูุบุงุก</button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Screen -->
    <div id="admin-dashboard-screen">
        <div class="control-panel no-print">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="user-info">
                    <strong>ููุญุฉ ุชุญูู ุงููุณุคูู</strong>
                    <span style="margin: 0 10px; color: #ccc;">|</span>
                    <span id="admin-grade-title">ุงูุตู ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู</span>
                </div>
                <button onclick="logoutAdmin()" class="tab-btn" style="background: #e74c3c; color: white;">ุชุณุฌูู ุฎุฑูุฌ
                    ๐</button>
            </div>

            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #ddd;">

            <div class="tabs" style="justify-content: center; margin-bottom: 10px;">
                <button class="tab-btn active" onclick="loadAdminStats(3)">3 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="loadAdminStats(4)">4 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="loadAdminStats(5)">5 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="loadAdminStats(6)">6 ุงุจุชุฏุงุฆู</button>
            </div>

            <!-- Admin View Switcher -->
            <div class="tabs" style="justify-content: center; background: #f1f2f6; padding: 5px; border-radius: 10px;">
                <button class="tab-btn active" id="btn-view-reports" onclick="switchAdminView('reports')">๐ ุชูุฑูุฑ
                    ุงูุฅุญุตุงุก</button>
                <button class="tab-btn" id="btn-view-status" onclick="switchAdminView('status')">๐ซ ูููู
                    ุงููุฏุงุฑุณ</button>
                <button onclick="exportAdminToExcel()" class="tab-btn" style="background: #27ae60; color: white;">๐ฅ
                    ุชุตุฏูุฑ Excel</button>
                <button onclick="window.print()" class="tab-btn"
                    style="background: var(--primary-color); color: white;">๐จ๏ธ ุทุจุงุนุฉ</button>
            </div>
        </div>

        <!-- View 1: Statistical Reports -->
        <div id="admin-view-reports" class="table-container">
            <!-- Print Header for Admin -->
            <div class="print-header-container">
                <!-- Visible in print only handled by CSS mostly, but logic here -->
                <div class="ph-right">
                    <h4>ูุฏูุฑูุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู ุจุงูุฌูุฒุฉ</h4>
                    <h4>ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ</h4>
                    <h4>ุงูุชุนููู ุงูุงุจุชุฏุงุฆู</h4>
                </div>
                <div class="ph-center">
                    <h2 id="admin-print-title">ุฅุญุตุงุก ูุฌูุน</h2>
                </div>
                <div class="ph-left">
                    <img src="logo.jpg" class="logo-img" alt="Logo">
                </div>
            </div>

            <h3 style="text-align: center; margin-bottom: 20px; color: var(--primary-color);">ุจูุงู ุฅุญุตุงุฆู ูุฌูุน</h3>

            <!-- Aggregated Table -->
            <table style="width: 100%; margin-bottom: 30px;">
                <thead>
                    <tr>
                        <th>ุงูุจูุงู</th>
                        <th>ุนุฏุฏ ุงููุฏุงุฑุณ</th>
                        <th>ุฌููุฉ ุงููุชูุฏููู</th>
                        <th>ุฌููุฉ ุงูุญุงุถุฑูู</th>
                        <th>ุนุฏุฏ ุงููุงุฌุญูู</th>
                        <th>ุงููุณุจุฉ ุงููุฆููุฉ %</th>
                        <th>ููุงุญุธุงุช</th>
                    </tr>
                </thead>
                <tbody id="admin-agg-body">
                    <!-- JS Injected -->
                </tbody>
            </table>

            <!-- Subjects Aggregated Table -->
            <h4 style="text-align: center; text-decoration: underline; margin: 10px 0;">ูุณุจ ุงููุฌุงุญ ูู ุงูููุงุฏ</h4>
            <table style="width: 100%;">
                <thead style="background-color: #fce4ec; color: #c2185b;">
                    <tr>
                        <th>ุงููุงุฏุฉ</th>
                        <th>ุงููุชูุฏููู</th>
                        <th>ุงูุญุงุถุฑูู</th>
                        <th>ุงููุงุฌุญูู</th>
                        <th>%</th>
                        <th>ููุงุญุธุงุช</th>
                    </tr>
                </thead>
                <tbody id="admin-subj-body">
                    <!-- JS Injected -->
                </tbody>
            </table>

            <!-- Signatures -->
            <div class="print-footer-container">
                <div class="signature-block">
                    <div class="sig-title">ุฑุฆูุณ ุงููุฌูุฉ</div>
                    <div
                        style="margin-top: 50px; border-top: 1px solid #000; display: inline-block; padding-top: 5px; min-width: 150px;">
                        ุงูุงุณู ูุงูุชูููุน</div>
                </div>
                <div class="signature-block">
                    <div class="sig-title">ูุฏูุฑ ุนุงู ุงูุฅุฏุงุฑุฉ</div>
                    <div
                        style="margin-top: 50px; border-top: 1px solid #000; display: inline-block; padding-top: 5px; min-width: 150px;">
                        ุงูุงุณู ูุงูุชูููุน</div>
                </div>
            </div>
        </div>

        <!-- View 2: School Status -->
        <div id="admin-view-status" class="table-container" style="display: none;">
            <h3 style="text-align: center; margin-bottom: 20px;">ูููู ุงููุฏุงุฑุณ ูู ุงูุชุณุฌูู</h3>

            <div style="display: flex; gap: 20px;">
                <!-- Submitted -->
                <div style="flex: 1; border: 1px solid #27ae60; border-radius: 8px; overflow: hidden;">
                    <h4 style="background: #27ae60; color: white; margin: 0; padding: 10px; text-align: center;">
                        ูุฏุงุฑุณ ุณุฌูุช (<span id="count-submitted">0</span>)
                    </h4>
                    <ul id="list-submitted"
                        style="list-style: none; padding: 10px; font-size: 0.9rem; max-height: 500px; overflow-y: auto;">
                    </ul>
                </div>

                <!-- Missing -->
                <div style="flex: 1; border: 1px solid #e74c3c; border-radius: 8px; overflow: hidden;">
                    <h4 style="background: #e74c3c; color: white; margin: 0; padding: 10px; text-align: center;">
                        ูุฏุงุฑุณ ูู ุชุณุฌู ุจุนุฏ (<span id="count-missing">0</span>)
                    </h4>
                    <ul id="list-missing"
                        style="list-style: none; padding: 10px; font-size: 0.9rem; max-height: 500px; overflow-y: auto;">
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboard-screen">

        <!-- Print Header -->
        <div class="print-header-container">
            <div class="ph-right">
                <h4>ูุฏูุฑูุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู ุจุงูุฌูุฒุฉ</h4>
                <h4>ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ</h4>
                <h4>ุงูุชุนููู ุงูุงุจุชุฏุงุฆู</h4>
                <!-- School Name -->
                <h4 id="print-school-name"
                    style="margin-top: 10px; font-weight: 800; border: 1px dashed black; padding: 5px; display: inline-block;">
                </h4>
            </div>
            <div class="ph-center">
                <h2 id="print-title">ุฅุญุตุงุก ูุตู ุงูุนุงู</h2>
                <p id="print-date" style="font-size: 11pt; margin: 5px 0;">ุงูุชุงุฑูุฎ: ____ / ____ / 2026</p>
            </div>
            <div class="ph-left">
                <img src="logo.jpg" class="logo-img" alt="Logo">
            </div>
        </div>

        <!-- UI Controls (Hidden in print) -->
        <div class="control-panel no-print">
            <div class="user-info">
                <strong>ูุฑุญุจุงูุ </strong> <span id="ui-school-name" style="color: var(--primary-color);"></span>
                <span style="margin: 0 10px; color: #ccc;">|</span>
                <span id="ui-school-type"></span>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="showGrade(3)">3 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="showGrade(4)">4 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="showGrade(5)">5 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="showGrade(6)">6 ุงุจุชุฏุงุฆู</button>
            </div>
            <div>
                <button onclick="printReport()" class="tab-btn"
                    style="background: var(--primary-color); color: white;">๐จ๏ธ ุทุจุงุนุฉ</button>
                <button onclick="saveData()" class="tab-btn" style="background: #27ae60; color: white;">๐พ ุญูุธ</button>
            </div>
        </div>

        <!-- Data Area -->
        <div id="form-area" class="table-container">
            <h3 class="no-print"
                style="margin-top: 0; color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px;">
                ุจูุงู ุฅุญุตุงุฆู: <span id="grade-title">ุงูุตู ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู</span>
            </h3>

            <!-- General Stats Table -->
            <h4 style="margin: 10px 0;">ุฃููุงู: ุงูุฅุญุตุงุก ุงูุนุงู</h4>
            <table>
                <thead>
                    <tr>
                        <th width="20%">ููุน ุงูุชุนููู</th>
                        <th width="20%">ุฌููุฉ ุงููุชูุฏููู</th>
                        <th width="20%">ุนุฏุฏ ุงูุญุงุถุฑูู</th>
                        <th width="20%">ุนุฏุฏ ุงููุงุฌุญูู</th>
                        <th width="20%">ุงููุณุจุฉ ุงููุฆููุฉ %</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="school-type-display">-</td>
                        <td><input type="number" id="gen_applied" class="sub-input" min="0"
                                oninput="validateNumberInput(this)" onchange="calcPerc('gen')"></td>
                        <td><input type="number" id="gen_present" class="sub-input" min="0"
                                oninput="validateNumberInput(this)" onchange="calcPerc('gen')"></td>
                        <td><input type="number" id="gen_success" class="sub-input" min="0"
                                oninput="validateNumberInput(this)" onchange="calcPerc('gen')"></td>
                        <td id="gen_perc" style="font-weight: bold;">0%</td>
                    </tr>
                </tbody>
            </table>

            <!-- Subjects Stats Table -->
            <h4 style="margin: 15px 0 10px;">ุซุงููุงู: ุฅุญุตุงุก ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ</h4>
            <table id="subjects-table">
                <thead>
                    <tr>
                        <th width="25%">ุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉ</th>
                        <th width="15%">ุงููุชูุฏููู</th>
                        <th width="15%">ุงูุญุงุถุฑูู</th>
                        <th width="15%">ุงููุงุฌุญูู</th>
                        <th width="15%">ุงููุณุจุฉ %</th>
                    </tr>
                </thead>
                <tbody id="subjects-body">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>
        </div>

        <!-- Print Footer Signatures -->
        <div class="print-footer-container">
            <!-- Right Side (First in RTL) -->
            <div class="sig-block">
                <div class="sig-title">ุฑุฆูุณ ูุฌูุฉ ุงููุธุงู ูุงููุฑุงูุจุฉ</div>
                <div
                    style="margin-top: 50px; border-top: 1px solid #000; display: inline-block; padding-top: 5px; min-width: 150px;">
                    ุงูุงุณู ูุงูุชูููุน</div>
            </div>
            <!-- Left Side (Second in RTL) -->
            <div class="sig-block">
                <div class="sig-title">ูุฏูุฑ ุงููุฏุฑุณุฉ</div>
                <div
                    style="margin-top: 50px; border-top: 1px solid #000; display: inline-block; padding-top: 5px; min-width: 150px;">
                    ุงูุงุณู ูุงูุชูููุน</div>
            </div>
        </div>

        <!-- Sticky Footer -->
        <div class="copyright-footer no-print">
            ุงูุชุนููู ุงูุงุจุชุฏุงุฆู ุงุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ 2026 &copy; | ุชุตููู ูุชุทููุฑ: <strong>Diaa El Attar</strong>
        </div>
    </div>

    <!-- SweetAlert2 Script -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // *** RENAME THIS IF DEPLOYING NEW VERSION ***
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz0dlQGnhz5WlXRcrcZbS5oEsPGpwpxx0ZlxAk-bPoiNnZYUwZ70IDcYc_lUWqP9dFGgw/exec";

        let currentSchool = {};
        let currentGrade = 3;
        let allSchoolsData = [];

        const subjectsConfig = {
            3: ["ูุบุฉ ุนุฑุจูุฉ", "ุฑูุงุถูุงุช", "ูุบุฉ ุงูุฌููุฒูุฉ", "ูุชุนุฏุฏ ุงูุชุฎุตุตุงุช", "ุชุฑุจูุฉ ุฏูููุฉ", "ุชููุงุชุณู", "ุชุฑุจูุฉ ุจุฏููุฉ"],
            4: ["ูุบุฉ ุนุฑุจูุฉ", "ุฑูุงุถูุงุช", "ูุบุฉ ุงูุฌููุฒูุฉ", "ุนููู", "ุฏุฑุงุณุงุช ุงุฌุชูุงุนูุฉ", "ููุงุฑุงุช ููููุฉ", "ุชูููููุฌูุง", "ุชุฑุจูุฉ ุฏูููุฉ", "ุชุฑุจูุฉ ุจุฏููุฉ", "ุชุฑุจูุฉ ูููุฉ", "ุชุฑุจูุฉ ููุณูููุฉ", "ุชููุงุชุณู"],
            5: ["ูุบุฉ ุนุฑุจูุฉ", "ุฑูุงุถูุงุช", "ูุบุฉ ุงูุฌููุฒูุฉ", "ุนููู", "ุฏุฑุงุณุงุช ุงุฌุชูุงุนูุฉ", "ููุงุฑุงุช ููููุฉ", "ุชูููููุฌูุง", "ุชุฑุจูุฉ ุฏูููุฉ", "ุชุฑุจูุฉ ุจุฏููุฉ", "ุชุฑุจูุฉ ูููุฉ", "ุชุฑุจูุฉ ููุณูููุฉ", "ุชููุงุชุณู"],
            6: ["ูุบุฉ ุนุฑุจูุฉ", "ุฑูุงุถูุงุช", "ูุบุฉ ุงูุฌููุฒูุฉ", "ุนููู", "ุฏุฑุงุณุงุช ุงุฌุชูุงุนูุฉ", "ููุงุฑุงุช ููููุฉ", "ุชูููููุฌูุง", "ุชุฑุจูุฉ ุฏูููุฉ", "ุชุฑุจูุฉ ุจุฏููุฉ", "ุชุฑุจูุฉ ูููุฉ", "ุชุฑุจูุฉ ููุณูููุฉ", "ุชููุงุชุณู"]
        };

        // Utility: Show Toast
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        window.onload = function () {
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getSchools" })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        allSchoolsData = data.schools;
                        populateTypes();
                        document.getElementById('loading-schools').style.display = 'none';
                        document.getElementById('login-form-area').style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loading-schools').innerHTML = `<span style="color:red; direction:ltr;">Error: ${err.message}</span><br>ุชุฃูุฏ ูู ุฅุนุฏุงุฏุงุช ุงููุดุฑ (Deploy) ูุฃู ุงูุตูุงุญูุงุช (Anyone).`;
                    Toast.fire({ icon: 'error', title: 'ูุดู ุงูุงุชุตุงู ุจุงูุฎุงุฏู', text: err.message });
                });
        };

        function populateTypes() {
            const typeSelect = document.getElementById('schoolTypeSelect');
            const types = [...new Set(allSchoolsData.map(s => s.type))];
            types.forEach(type => {
                let opt = document.createElement('option');
                opt.value = type;
                opt.innerText = type;
                typeSelect.appendChild(opt);
            });
        }

        function filterSchools() {
            const selectedType = document.getElementById('schoolTypeSelect').value;
            const nameSelect = document.getElementById('schoolNameSelect');
            nameSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุฏุฑุณุฉ...</option>';

            const filtered = allSchoolsData.filter(s => s.type === selectedType);
            filtered.forEach(s => {
                let opt = document.createElement('option');
                opt.value = s.name;
                opt.innerText = s.name;
                nameSelect.appendChild(opt);
            });
        }

        /* --- Admin Logic --- */
        function showAdminLogin() {
            document.getElementById('admin-login-modal').style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function submitAdminLogin() {
            const pass = document.getElementById('admin-pass-input').value;
            if (!pass) return;

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "adminLogin", password: pass })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        closeModal('admin-login-modal');
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('admin-dashboard-screen').style.display = 'block';
                        loadAdminStats(3); // Default load
                        Toast.fire({ icon: 'success', title: 'ูุฑุญุจุงู ุจุงููุณุคูู' });
                    } else {
                        Swal.fire('ุฎุทุฃ', 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ', 'error');
                    }
                });
        }

        function logoutAdmin() {
            document.getElementById('admin-dashboard-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
        }

        function switchAdminView(view) {
            // Remove active from buttons
            document.getElementById('btn-view-reports').classList.remove('active');
            document.getElementById('btn-view-status').classList.remove('active');

            // Hide all views
            document.getElementById('admin-view-reports').style.display = 'none';
            document.getElementById('admin-view-status').style.display = 'none';

            // Activate Selected
            document.getElementById('btn-view-' + view).classList.add('active');
            document.getElementById('admin-view-' + view).style.display = 'block';
        }

        function loadAdminStats(grade) {
            currentAdminGrade = grade; // Track current grade

            // Update UI Tabs
            document.querySelectorAll('#admin-dashboard-screen .tab-btn').forEach(b => b.classList.remove('active'));
            // This relies on order 3,4,5,6
            const tabs = document.querySelectorAll('#admin-dashboard-screen .tab-btn');
            if (tabs[grade - 3]) tabs[grade - 3].classList.add('active');

            const gradeText = grade == 3 ? 'ุงูุตู ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู' : grade == 4 ? 'ุงูุตู ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู' : grade == 5 ? 'ุงูุตู ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู' : 'ุงูุตู ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู';
            document.getElementById('admin-grade-title').innerText = gradeText;

            // Show Loading
            Swal.fire({ title: 'ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getAdminStats", grade: grade })
            })
                .then(res => res.json())
                .then(data => {
                    Swal.close();
                    if (data.status === "success") {
                        renderAdminTables(data, grade);
                    } else {
                        Toast.fire({ icon: 'error', title: 'ูุดู ุชุญููู ุงูุจูุงูุงุช' });
                    }
                });
        }

        function renderAdminTables(data, grade) {
            const aggBody = document.getElementById('admin-agg-body');
            const subjBody = document.getElementById('admin-subj-body');
            aggBody.innerHTML = "";
            subjBody.innerHTML = "";

            // 1. School Types Table
            const typesOrder = ["ุฑุณูู ุนุฑุจู", "ุฑุณูู ูุบุงุช", "ุฎุงุต ุนุฑุจู", "ุฎุงุต ูุบุงุช", "ุฏููู"]; // Match Backend
            let totalSchools = 0, totalApp = 0, totalPre = 0, totalSuc = 0;

            typesOrder.forEach(t => {
                let rowData = data.aggregations[t] || { count: 0, applied: 0, present: 0, success: 0 };
                let perc = rowData.present > 0 ? ((rowData.success / rowData.present) * 100).toFixed(1) + "%" : "0%";

                totalSchools += rowData.count;
                totalApp += rowData.applied;
                totalPre += rowData.present;
                totalSuc += rowData.success;

                aggBody.innerHTML += `
                    <tr>
                        <td>ูุฏุงุฑุณ ${t}</td>
                        <td>${rowData.count}</td>
                        <td>${rowData.applied}</td>
                        <td>${rowData.present}</td>
                        <td>${rowData.success}</td>
                        <td>${perc}</td>
                        <td></td>
                    </tr>
                `;
            });

            // Total Row
            let totalPerc = totalPre > 0 ? ((totalSuc / totalPre) * 100).toFixed(1) + "%" : "0%";
            aggBody.innerHTML += `
                <tr style="background-color: #eee;">
                    <td>ุงูุฅุฌูุงูู</td>
                    <td>${totalSchools}</td>
                    <td>${totalApp}</td>
                    <td>${totalPre}</td>
                    <td>${totalSuc}</td>
                    <td>${totalPerc}</td>
                    <td></td>
                </tr>
            `;

            // 2. Subjects Table
            data.subjectsAgg.forEach((subjData, idx) => {
                let subjName = subjectsConfig[grade][idx];
                let perc = subjData.present > 0 ? ((subjData.success / subjData.present) * 100).toFixed(1) + "%" : "0%";

                subjBody.innerHTML += `
                    <tr>
                        <td>${subjName}</td>
                        <td>${subjData.applied}</td>
                        <td>${subjData.present}</td>
                        <td>${subjData.success}</td>
                        <td>${perc}</td>
                        <td></td>
                    </tr>
                `;
            });

            // 3. Render School Lists
            const listSub = document.getElementById('list-submitted');
            const listMis = document.getElementById('list-missing');
            listSub.innerHTML = "";
            listMis.innerHTML = "";

            document.getElementById('count-submitted').innerText = data.submittedSchools.length;
            document.getElementById('count-missing').innerText = data.missingSchools.length;

            data.submittedSchools.forEach(s => {
                listSub.innerHTML += `<li style="border-bottom: 1px solid #eee; padding: 5px;">โ ${s}</li>`;
            });

            data.missingSchools.forEach(s => {
                listMis.innerHTML += `<li style="border-bottom: 1px solid #eee; padding: 5px;">โ ${s}</li>`;
            });
        }

        // Export Admin Data to Excel
        function exportAdminToExcel() {
            const currentAdminGrade = getCurrentAdminGrade(); // We need to track this

            Swal.fire({
                title: 'ุฌุงุฑู ุชุตุฏูุฑ ุงูุจูุงูุงุช...',
                html: 'ูุชู ุงูุขู ุฅูุดุงุก ููู Excelุ ูุฑุฌู ุงูุงูุชุธุงุฑ...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "exportToExcel",
                    grades: [3, 4, 5, 6] // Export all grades
                })
            })
                .then(res => res.json())
                .then(data => {
                    Swal.close();
                    if (data.status === "success") {
                        Swal.fire({
                            icon: 'success',
                            title: 'ุชู ุงูุชุตุฏูุฑ ุจูุฌุงุญ!',
                            html: `<p>ุชู ุฅูุดุงุก ููู Excel ุจูุฌุงุญ.</p>
                                   <a href="${data.fileUrl}" target="_blank" style="color: #27ae60; font-weight: bold;">
                                   ๐ฅ ุงุถุบุท ููุง ููุชุญ ุงูููู</a>`,
                            confirmButtonColor: 'var(--primary-color)'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'ูุดู ุงูุชุตุฏูุฑ',
                            text: data.message || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุตุฏูุฑ',
                            confirmButtonColor: '#e74c3c'
                        });
                    }
                })
                .catch(err => {
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'ุฎุทุฃ ูู ุงูุงุชุตุงู',
                        text: 'ุชุนุฐุฑ ุงูุงุชุตุงู ุจุงูุฎุงุฏูุ ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.',
                        confirmButtonColor: '#e74c3c'
                    });
                });
        }

        // Helper to get current admin grade (we need to track this)
        let currentAdminGrade = 3; // Default
        function getCurrentAdminGrade() {
            return currentAdminGrade;
        }

        /* --- Validation Logic --- */
        function validateNumberInput(input) {
            // Remove non-numeric chars
            input.value = input.value.replace(/[^0-9]/g, '');
            // Prevent negative (though regex handles it mostly)
            if (input.value && parseInt(input.value) < 0) input.value = 0;
        }

        /* --- Password Logic --- */
        function showPasswordModal() {
            document.getElementById('password-modal').style.display = 'block';
            document.getElementById('old-pass').value = "";
            document.getElementById('new-pass').value = "";
        }

        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
        }

        function changePassword() {
            const name = document.getElementById('schoolNameSelect').value;
            const oldCode = document.getElementById('old-pass').value;
            const newCode = document.getElementById('new-pass').value;

            if (!name) {
                Toast.fire({ icon: 'warning', title: 'ุงุฎุชุฑ ุงููุฏุฑุณุฉ ุฃููุงู ูู ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ' });
                return;
            }
            if (!oldCode || !newCode) {
                Toast.fire({ icon: 'warning', title: 'ูุฑุฌู ููุก ุฌููุน ุงูุญููู' });
                return;
            }
            if (!/^\d+$/.test(newCode)) {
                Toast.fire({ icon: 'error', title: 'ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ูุฌุจ ุฃู ุชููู ุฃุฑูุงูุงู ููุท' });
                return;
            }

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "changePassword",
                    name: name,
                    oldCode: oldCode,
                    newCode: newCode
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        Swal.fire({
                            icon: 'success',
                            title: 'ุชู ุจูุฌุงุญ!',
                            text: data.message,
                            confirmButtonText: 'ุญุณูุงู',
                            confirmButtonColor: 'var(--primary-color)'
                        });
                        closePasswordModal();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'ุฎุทุฃ',
                            text: data.message,
                            confirmButtonText: 'ุญุงูููุฉ ูุฑุฉ ุฃุฎุฑู',
                            confirmButtonColor: '#e74c3c'
                        });
                    }
                })
                .catch(err => {
                    Toast.fire({ icon: 'error', title: 'ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู' });
                });
        }


        /* --- Login & App Logic --- */
        function login() {
            const type = document.getElementById('schoolTypeSelect').value;
            const name = document.getElementById('schoolNameSelect').value;
            const code = document.getElementById('schoolCode').value;

            const btn = document.querySelector('.login-btn');

            if (!type || !name || !code) {
                Toast.fire({ icon: 'warning', title: 'ูุฑุฌู ุงุณุชููุงู ุฌููุน ุงูุจูุงูุงุช' });
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'ุฌุงุฑู ุงูุชุญูู... <span style="display:inline-block;animation:spin 1s infinite">โป</span>';

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "login", name: name, code: code })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        currentSchool = data.schoolData;

                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('dashboard-screen').style.display = 'block';
                        document.body.style.justifyContent = 'flex-start';

                        document.getElementById('print-school-name').innerText = "ูุฏุฑุณุฉ: " + currentSchool.name;
                        document.getElementById('ui-school-name').innerText = currentSchool.name;
                        document.getElementById('school-type-display').innerText = currentSchool.type;
                        document.getElementById('ui-school-type').innerText = currentSchool.type;

                        showGrade(3);

                        Toast.fire({ icon: 'success', title: 'ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ' });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'ุฎุทุฃ ูู ุงูุฏุฎูู',
                            text: data.message,
                            confirmButtonColor: '#e74c3c',
                            confirmButtonText: 'ุญุงูู ูุฑุฉ ุฃุฎุฑู'
                        });
                        btn.disabled = false;
                        btn.innerText = "ุชุณุฌูู ุงูุฏุฎูู";
                    }
                })
                .catch(err => {
                    Toast.fire({ icon: 'error', title: 'ูุดู ุงูุงุชุตุงู ุจุงูุฎุงุฏู' });
                    btn.disabled = false;
                    btn.innerText = "ุชุณุฌูู ุงูุฏุฎูู";
                });
        }

        function showGrade(grade) {
            currentGrade = grade;
            const gradeText = grade == 3 ? 'ุงูุซุงูุซ' : grade == 4 ? 'ุงูุฑุงุจุน' : grade == 5 ? 'ุงูุฎุงูุณ' : 'ุงูุณุงุฏุณ';

            document.getElementById('grade-title').innerText = `ุงูุตู ${gradeText} ุงูุงุจุชุฏุงุฆู`;
            document.getElementById('print-title').innerText = `ุฅุญุตุงุก ูุชูุฌุฉ ุงูุชุญุงู ุงูุตู ${gradeText} ูุงูุชุญุงูุงุช ูุตู ุงูุนุงู 2025 / 2026 ู`;

            // Update active tab (fix: target only dashboard tabs, not admin tabs)
            const dashboardTabs = document.querySelectorAll('#dashboard-screen .tabs .tab-btn');
            dashboardTabs.forEach(b => b.classList.remove('active'));
            if (dashboardTabs[grade - 3]) dashboardTabs[grade - 3].classList.add('active');

            const tbody = document.getElementById('subjects-body');
            tbody.innerHTML = "";

            subjectsConfig[grade].forEach((subj, index) => {
                let row = `
                    <tr>
                        <td style="font-weight:bold; background-color: #fafafa;">${subj}</td>
                        <td><input type="number" id="app_${index}" class="sub-input" min="0" oninput="validateNumberInput(this)" onchange="calcRowPerc(${index})"></td>
                        <td><input type="number" id="pre_${index}" class="sub-input" min="0" oninput="validateNumberInput(this)" onchange="calcRowPerc(${index})"></td>
                        <td><input type="number" id="suc_${index}" class="sub-input" min="0" oninput="validateNumberInput(this)" onchange="calcRowPerc(${index})"></td>
                        <td id="perc_${index}" style="font-weight:bold; direction:ltr;">0%</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Load saved data for this grade
            loadSavedDataForGrade(grade);
        }

        // Load previously saved data for a specific grade
        function loadSavedDataForGrade(grade) {
            if (!currentSchool || !currentSchool.id) {
                return; // Not logged in yet
            }

            // Show loading indicator
            Toast.fire({ icon: 'info', title: 'ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...' });

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "getSchoolStats",
                    grade: grade,
                    schoolId: currentSchool.id
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success" && data.statsData) {
                        populateFormWithData(data.statsData, grade);
                        Toast.fire({
                            icon: 'success',
                            title: 'ุชู ุชุญููู ุงูุจูุงูุงุช ุงููุญููุธุฉ',
                            timer: 2000
                        });
                    } else if (data.status === "notfound") {
                        // No saved data, that's okay - form stays empty
                        clearAllFields();
                    } else {
                        Toast.fire({
                            icon: 'warning',
                            title: 'ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุธุฉ ููุฐุง ุงูุตู',
                            timer: 2000
                        });
                        clearAllFields();
                    }
                })
                .catch(err => {
                    console.error("Error loading saved data:", err);
                    clearAllFields();
                });
        }

        // Populate form fields with saved data
        function populateFormWithData(statsData, grade) {
            // statsData format: [gen_applied, gen_present, gen_success, subj1_app, subj1_pre, subj1_suc, ...]

            if (statsData.length < 3) return;

            // Fill general stats
            document.getElementById('gen_applied').value = statsData[0] || '';
            document.getElementById('gen_present').value = statsData[1] || '';
            document.getElementById('gen_success').value = statsData[2] || '';
            calcPerc('gen');

            // Fill subject stats
            const numSubjects = subjectsConfig[grade].length;
            for (let i = 0; i < numSubjects; i++) {
                const baseIdx = 3 + (i * 3); // Start after general stats

                if (baseIdx < statsData.length) {
                    document.getElementById(`app_${i}`).value = statsData[baseIdx] || '';
                }
                if (baseIdx + 1 < statsData.length) {
                    document.getElementById(`pre_${i}`).value = statsData[baseIdx + 1] || '';
                }
                if (baseIdx + 2 < statsData.length) {
                    document.getElementById(`suc_${i}`).value = statsData[baseIdx + 2] || '';
                }

                calcRowPerc(i);
            }
        }

        // Clear all form fields
        function clearAllFields() {
            document.getElementById('gen_applied').value = '';
            document.getElementById('gen_present').value = '';
            document.getElementById('gen_success').value = '';
            document.getElementById('gen_perc').innerText = '0%';

            const numSubjects = subjectsConfig[currentGrade].length;
            for (let i = 0; i < numSubjects; i++) {
                document.getElementById(`app_${i}`).value = '';
                document.getElementById(`pre_${i}`).value = '';
                document.getElementById(`suc_${i}`).value = '';
                document.getElementById(`perc_${i}`).innerText = '0%';
            }
        }

        function calcPerc(type) {
            let app = parseFloat(document.getElementById(type + '_applied').value) || 0;
            let pre = parseFloat(document.getElementById(type + '_present').value) || 0;
            let suc = parseFloat(document.getElementById(type + '_success').value) || 0;

            let appInput = document.getElementById(type + '_applied');
            let preInput = document.getElementById(type + '_present');
            let sucInput = document.getElementById(type + '_success');

            [appInput, preInput, sucInput].forEach(el => el.classList.remove('input-error'));

            if (pre > app) {
                Toast.fire({ icon: 'error', title: 'ุชูุจูู: ุงูุญุงุถุฑูู ุฃูุจุฑ ูู ุงููุชูุฏููู' });
                preInput.classList.add('input-error');
                return;
            }
            if (suc > pre) {
                Toast.fire({ icon: 'error', title: 'ุชูุจูู: ุงููุงุฌุญูู ุฃูุจุฑ ูู ุงูุญุงุถุฑูู' });
                sucInput.classList.add('input-error');
                return;
            }

            if (pre > 0) {
                let perc = ((suc / pre) * 100).toFixed(1);
                document.getElementById(type + '_perc').innerText = perc + "%";
            } else {
                document.getElementById(type + '_perc').innerText = "0%";
            }

            if (type === 'gen' && app > 0) updateAllSubjectsApplied(app);
        }

        function updateAllSubjectsApplied(val) {
            subjectsConfig[currentGrade].forEach((_, index) => {
                let input = document.getElementById(`app_${index}`);
                if (input) {
                    input.value = val;
                    // Trigger calc to update percentages if present/success exist
                    calcRowPerc(index);
                }
            });
        }

        function calcRowPerc(index) {
            let app = parseFloat(document.getElementById(`app_${index}`).value) || 0;
            let pre = parseFloat(document.getElementById(`pre_${index}`).value) || 0;
            let suc = parseFloat(document.getElementById(`suc_${index}`).value) || 0;

            let appInput = document.getElementById(`app_${index}`);
            let preInput = document.getElementById(`pre_${index}`);
            let sucInput = document.getElementById(`suc_${index}`);

            [appInput, preInput, sucInput].forEach(el => el.classList.remove('input-error'));

            if (pre > app) {
                preInput.classList.add('input-error');
                Toast.fire({ icon: 'error', title: 'ุฎุทุฃ: ุงูุญุงุถุฑ ุฃูุจุฑ ูู ุงููุชูุฏู' });
                return;
            }
            if (suc > pre) {
                sucInput.classList.add('input-error');
                Toast.fire({ icon: 'error', title: 'ุฎุทุฃ: ุงููุงุฌุญ ุฃูุจุฑ ูู ุงูุญุงุถุฑ' });
                return;
            }

            if (pre > 0) {
                let perc = ((suc / pre) * 100).toFixed(1);
                document.getElementById(`perc_${index}`).innerText = perc + "%";
            } else {
                document.getElementById(`perc_${index}`).innerText = "0%";
            }
        }

        // Helper to check for errors and missing data
        function hasValidationErrors() {
            // Check for red inputs (logical errors)
            if (document.querySelectorAll('.input-error').length > 0) return true;
            return false;
        }

        // Comprehensive validation: checks if all required fields are filled
        function validateAllData() {
            const missingFields = [];

            // Check general stats
            const genApplied = document.getElementById('gen_applied').value;
            const genPresent = document.getElementById('gen_present').value;
            const genSuccess = document.getElementById('gen_success').value;

            if (!genApplied || genApplied === '0') missingFields.push('ุฌููุฉ ุงููุชูุฏููู (ุงูุฅุญุตุงุก ุงูุนุงู)');
            if (!genPresent || genPresent === '0') missingFields.push('ุนุฏุฏ ุงูุญุงุถุฑูู (ุงูุฅุญุตุงุก ุงูุนุงู)');
            if (!genSuccess || genSuccess === '0') missingFields.push('ุนุฏุฏ ุงููุงุฌุญูู (ุงูุฅุญุตุงุก ุงูุนุงู)');

            // Check all subjects
            const subjects = subjectsConfig[currentGrade];
            subjects.forEach((subj, index) => {
                const app = document.getElementById(`app_${index}`).value;
                const pre = document.getElementById(`pre_${index}`).value;
                const suc = document.getElementById(`suc_${index}`).value;

                if (!app || app === '0') missingFields.push(`ุงููุชูุฏููู - ${subj}`);
                if (!pre || pre === '0') missingFields.push(`ุงูุญุงุถุฑูู - ${subj}`);
                if (!suc || suc === '0') missingFields.push(`ุงููุงุฌุญูู - ${subj}`);
            });

            return missingFields;
        }

        function printReport() {
            // Check for logical errors first
            if (hasValidationErrors()) {
                Swal.fire({
                    icon: 'error',
                    title: 'ูุง ูููู ุงูุทุจุงุนุฉ!',
                    text: 'ุชูุฌุฏ ุฃุฎุทุงุก ูู ุงูุจูุงูุงุช (ุฎุงูุงุช ุจุงูููู ุงูุฃุญูุฑ). ูุฑุฌู ุชุตุญูุญูุง ุฃููุงู.',
                    confirmButtonColor: '#e74c3c'
                });
                return;
            }

            // Check for missing data
            const missingFields = validateAllData();
            if (missingFields.length > 0) {
                const fieldsText = missingFields.slice(0, 5).join('\nโข ');
                const moreText = missingFields.length > 5 ? `\n... ู ${missingFields.length - 5} ุญููู ุฃุฎุฑู` : '';

                Swal.fire({
                    icon: 'warning',
                    title: 'ุจูุงูุงุช ูุงูุตุฉ!',
                    html: `<div style="text-align: right; direction: rtl;">
                        <p>ูุฌุจ ุฅุฏุฎุงู ุฌููุน ุงูุจูุงูุงุช ูุจู ุงูุทุจุงุนุฉ.</p>
                        <p><strong>ุงูุญููู ุงูููููุฏุฉ (${missingFields.length}):</strong></p>
                        <p style="color: #e74c3c; font-size: 0.9rem;">โข ${fieldsText}${moreText}</p>
                    </div>`,
                    confirmButtonColor: 'var(--primary-color)',
                    confirmButtonText: 'ุญุณูุงู'
                });
                return;
            }

            window.print();
        }

        function saveData() {
            // Check for logical errors first
            if (hasValidationErrors()) {
                Swal.fire({
                    icon: 'error',
                    title: 'ูุง ูููู ุงูุญูุธ!',
                    text: 'ุชูุฌุฏ ุฃุฎุทุงุก ูู ุงูุจูุงูุงุช (ุฎุงูุงุช ุจุงูููู ุงูุฃุญูุฑ). ูุฑุฌู ุชุตุญูุญูุง ุฃููุงู.',
                    confirmButtonColor: '#e74c3c'
                });
                return;
            }

            // Check for missing data
            const missingFields = validateAllData();
            if (missingFields.length > 0) {
                const fieldsText = missingFields.slice(0, 5).join('\nโข ');
                const moreText = missingFields.length > 5 ? `\n... ู ${missingFields.length - 5} ุญููู ุฃุฎุฑู` : '';

                Swal.fire({
                    icon: 'warning',
                    title: 'ุจูุงูุงุช ูุงูุตุฉ!',
                    html: `<div style="text-align: right; direction: rtl;">
                        <p>ูุฌุจ ุฅุฏุฎุงู ุฌููุน ุงูุจูุงูุงุช ูุจู ุงูุญูุธ.</p>
                        <p><strong>ุงูุญููู ุงูููููุฏุฉ (${missingFields.length}):</strong></p>
                        <p style="color: #e74c3c; font-size: 0.9rem;">โข ${fieldsText}${moreText}</p>
                    </div>`,
                    confirmButtonColor: 'var(--primary-color)',
                    confirmButtonText: 'ุญุณูุงู'
                });
                return;
            }

            Swal.fire({
                title: 'ูู ุฃูุช ูุชุฃูุฏุ',
                text: "ุณูุชู ุญูุธ ุงูุจูุงูุงุชุ ูุฑุฌู ุงููุฑุงุฌุนุฉ ุจุฏูุฉ.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: 'var(--primary-color)',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ูุนูุ ุญูุธ ุงูุจูุงูุงุช',
                cancelButtonText: 'ุฅูุบุงุก'
            }).then((result) => {
                if (result.isConfirmed) {
                    performSave();
                }
            })
        }

        function performSave() {
            const btn = document.querySelector('button[onclick="saveData()"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "ุฌุงุฑู ุงูุญูุธ...";

            let statsData = [
                document.getElementById('gen_applied').value || 0,
                document.getElementById('gen_present').value || 0,
                document.getElementById('gen_success').value || 0
            ];

            subjectsConfig[currentGrade].forEach((_, index) => {
                statsData.push(document.getElementById(`app_${index}`).value || 0);
                statsData.push(document.getElementById(`pre_${index}`).value || 0);
                statsData.push(document.getElementById(`suc_${index}`).value || 0);
            });

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "saveStats",
                    grade: currentGrade,
                    schoolId: currentSchool.id,
                    schoolName: currentSchool.name,
                    statsData: statsData
                })
            })
                .then(res => res.json())
                .then(data => {
                    Swal.fire(
                        'ุชู ุงูุญูุธ!',
                        data.message,
                        'success'
                    );
                    btn.disabled = false;
                    btn.innerText = originalText;
                })
                .catch(err => {
                    Swal.fire(
                        'ุฎุทุฃ',
                        'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธุ ุญุงูู ูุฑุฉ ุฃุฎุฑู.',
                        'error'
                    );
                    btn.disabled = false;
                    btn.innerText = originalText;
                });
        }
    </script>
</body>

</html>