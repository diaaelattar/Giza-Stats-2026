<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ููุธููุฉ ุงูุฅุญุตุงุก - ูุญุงูุธุฉ ุงูุฌูุฒุฉ</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css?v=3">
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</head>

<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-card">
            <img src="logo.jpg" alt="Logo" style="width: 60px; margin-bottom: 15px;">
            <h2>ูุญุงูุธุฉ ุงูุฌูุฒุฉ</h2>
            <h3>ููุธููุฉ ุฅุญุตุงุก ุงูุชุนููู ุงูุงุจุชุฏุงุฆู</h3>
            <p style="margin-top: -15px; margin-bottom: 20px; color: #666; font-size: 0.9rem;">ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ
                - ุงูุชุนููู ุงูุงุจุชุฏุงุฆู</p>

            <!-- Dynamic Dropdowns -->
            <div id="loading-schools" style="margin: 20px 0; color: #666;">ุฌุงุฑู ุชุญููู ูุงุฆูุฉ ุงููุฏุงุฑุณ...</div>

            <div id="login-form-area" style="display: none; width: 100%;">
                <select id="schoolTypeSelect" onchange="filterSchools()">
                    <option value="">ุงุฎุชุฑ ููุน ุงูุชุนููู...</option>
                </select>

                <select id="schoolNameSelect">
                    <option value="">ุงุฎุชุฑ ุงููุฏุฑุณุฉ...</option>
                </select>

                <input type="password" id="schoolCode" placeholder="ููุฏ ุงููุฏุฑุณุฉ (ุงูุฑูู ุงูุณุฑู)">
                <button class="login-btn" onclick="login()">ุชุณุฌูู ุงูุฏุฎูู</button>

                <div style="margin-top: 15px;">
                    <a href="#" onclick="showPasswordModal()"
                        style="font-size: 0.9rem; color: var(--primary-color); text-decoration: none;">ุชุบููุฑ ูููุฉ
                        ุงููุฑูุฑ</a>
                    <span style="color:#ccc; margin:0 5px;">|</span>
                    <a href="#" onclick="showAdminLogin()"
                        style="font-size: 0.9rem; color: #e74c3c; text-decoration: none;">ุฏุฎูู ุงููุณุคูู (Admin)</a>
                </div>
            </div>
        </div>
        <div class="copyright-footer" style="background: transparent; border: none; font-size: 0.8rem;">
            ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ 2026 &copy; <br>
            <span style="display:block; margin: 5px 0;">ุงููุณุฎุฉ 2.5 (ุดุงููุฉ ุงูุชูููู)</span>
            ุชุญุช ุฅุดุฑุงู: <span style="font-weight: bold; color: var(--bs-indigo);">ุฃ/ ูุดุงู ูุญููุฏ</span><br>
            ุชุทููุฑ: <span style="font-family: sans-serif; font-weight: bold;">Diaa El Attar</span>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="modal">
        <div class="modal-content" style="border-top: 5px solid #e74c3c;">
            <h3 style="color: #e74c3c;">ุฏุฎูู ุงููุณุคูู</h3>
            <input type="password" id="admin-pass-input" placeholder="ูููุฉ ูุฑูุฑ ุงููุณุคูู">
            <button class="modal-btn" style="background: #e74c3c; color: white;"
                onclick="submitAdminLogin()">ุฏุฎูู</button>
            <button class="modal-btn" style="background: #7f8c8d; color: white;"
                onclick="closeModal('admin-login-modal')">ุฅูุบุงุก</button>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--primary-color);">ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</h3>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">ุงุฎุชุฑ ุงููุฏุฑุณุฉ ูู ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ ุฃููุงู</p>

            <input type="password" id="old-pass" placeholder="ูููุฉ ุงููุฑูุฑ ุงููุฏููุฉ">
            <input type="text" id="new-pass" placeholder="ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ (ุฃุฑูุงู ููุท)"
                oninput="validateNumberInput(this)">

            <div style="margin-top: 15px;">
                <button class="modal-btn" style="background: var(--primary-color); color: white;"
                    onclick="changePassword()">ุญูุธ ุงูุชุบููุฑ</button>
                <button class="modal-btn" style="background: #e74c3c; color: white;"
                    onclick="closeModal('password-modal')">ุฅูุบุงุก</button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Screen -->
    <div id="admin-dashboard-screen" style="display:none;">
        <div class="control-panel no-print">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="user-info">
                    <strong>ููุญุฉ ุชุญูู ุงููุณุคูู</strong>
                    <span style="margin: 0 10px; color: #ccc;">|</span>
                    <span id="admin-grade-title">ุงูุตู ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู</span>
                </div>
                <button onclick="logoutAdmin()" class="tab-btn" style="background: #e74c3c; color: white;">ุชุณุฌูู ุฎุฑูุฌ
                    ๐</button>
            </div>

            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #ddd;">

            <div class="tabs" style="justify-content: center; margin-bottom: 10px;">
                <button class="tab-btn" onclick="loadAdminEvalStats(1)">1 ุงุจุชุฏุงุฆู (ุชูููู)</button>
                <button class="tab-btn" onclick="loadAdminEvalStats(2)">2 ุงุจุชุฏุงุฆู (ุชูููู)</button>
                <button class="tab-btn active" onclick="loadAdminStats(3)">3 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="loadAdminStats(4)">4 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="loadAdminStats(5)">5 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="loadAdminStats(6)">6 ุงุจุชุฏุงุฆู</button>
            </div>

            <!-- Admin View Switcher -->
            <div class="tabs" style="justify-content: center; background: #f1f2f6; padding: 5px; border-radius: 10px;">
                <button class="tab-btn active" id="btn-view-reports" onclick="switchAdminView('reports')">๐ ุชูุฑูุฑ
                    ุงูุฅุญุตุงุก</button>
                <button class="tab-btn" id="btn-view-status" onclick="switchAdminView('status')">๐ซ ูููู
                    ุงููุฏุงุฑุณ</button>
                <button onclick="exportAdminToExcel()" class="tab-btn" style="background: #27ae60; color: white;">๐ฅ
                    ุชุตุฏูุฑ Excel</button>
                <button onclick="printAdminReport()" class="tab-btn"
                    style="background: var(--primary-color); color: white;">๐จ๏ธ ุทุจุงุนุฉ</button>
            </div>
        </div>

        <!-- View 1: Statistical Reports -->
        <div id="admin-view-reports" class="table-container">
            <!-- Content will be injected dynamically -->
        </div>

        <!-- View 2: School Status -->
        <div id="admin-view-status" class="table-container" style="display: none;">
            <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                <div class="status-card success">
                    <h4>ุงููุฏุงุฑุณ ุงููุณุฌูุฉ (<span id="count-submitted">0</span>)</h4>
                    <ul id="list-submitted" class="status-list"></ul>
                </div>
                <div class="status-card warning">
                    <h4>ูุฏุงุฑุณ ูู ุชุณุฌู (<span id="count-missing">0</span>)</h4>
                    <ul id="list-missing" class="status-list"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Print Area for Official Reports -->
    <div id="school-print-area" style="display:none;"></div>

    <!-- School Dashboard Screen (Data Entry) -->
    <div id="dashboard-screen" style="display:none;">
        <div class="control-panel no-print">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="user-info">
                    <strong id="ui-school-name">ูุฏุฑุณุฉ...</strong>
                    <span id="ui-school-type"
                        style="font-size: 0.8rem; background: #eee; padding: 2px 8px; border-radius: 4px; margin-right: 5px;">ููุน
                        ุงูุชุนููู</span>
                </div>
                <div>
                    <button onclick="logout()" class="tab-btn" style="background: #e74c3c; color: white;">ุชุณุฌูู ุฎุฑูุฌ
                        ๐</button>
                </div>
            </div>

            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #ddd;">

            <div class="tabs" style="justify-content: center;">
                <button class="tab-btn" onclick="showEvalGrade(1)">1 ุงุจุชุฏุงุฆู (ุชูููู)</button>
                <button class="tab-btn" onclick="showEvalGrade(2)">2 ุงุจุชุฏุงุฆู (ุชูููู)</button>
                <button class="tab-btn active" onclick="showGrade(3)">3 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="showGrade(4)">4 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="showGrade(5)">5 ุงุจุชุฏุงุฆู</button>
                <button class="tab-btn" onclick="showGrade(6)">6 ุงุจุชุฏุงุฆู</button>
            </div>
        </div>

        <!-- Print Header School -->
        <div class="print-header-container">
            <div class="ph-right">
                <h4>ูุฏูุฑูุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู ุจุงูุฌูุฒุฉ</h4>
                <h4>ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ</h4>
                <h4>ุงูุชุนููู ุงูุงุจุชุฏุงุฆู</h4>
                <h4 style="margin-top: 5px;">ูุฏุฑุณุฉ: <span id="print-school-name" style="font-weight: 400;">...</span>
                </h4>
            </div>
            <div class="ph-center">
                <h2 id="print-title">ุฅุญุตุงุก ูุตู ุงูุนุงู</h2>
                <h3 id="grade-title">ุงูุตู ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู</h3>
            </div>
            <div class="ph-left">
                <img src="logo.jpg" class="logo-img" alt="Logo">
            </div>
        </div>

        <h3 id="form-grade-title" class="no-print"
            style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">ุฅุฏุฎุงู ุจูุงูุงุช ุงูุฅุญุตุงุก</h3>

        <!-- General Stats Table (Input) -->
        <h4 style="margin: 10px 0;">ุฃููุงู: ุงูุฅุญุตุงุก ุงูุนุงู</h4>
        <div style="overflow-x:auto;">
            <table style="min-width: 800px; table-layout: fixed; width: 100%;">
                <colgroup>
                    <col style="width: 100px;"> <!-- ุงูุจูุงู -->
                    <!-- 15 Numeric Columns: All 32px for complete fit -->
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                </colgroup>
                <thead>
                    <tr>
                        <th rowspan="2">ุงูุจูุงู</th>
                        <th colspan="3">ุงููููุฏ</th>
                        <th colspan="3">ุงูุญุงุถุฑ</th>
                        <th colspan="3">50% ูุฃูุซุฑ (ูุงุฌุญ)</th>
                        <th colspan="3">ุฃูู ูู 50% (ุฏูู ุงููุณุชูู)</th>
                        <th colspan="3">ุงูุบูุงุจ</th>
                    </tr>
                    <tr>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="school-type-display" style="font-weight:bold;">-</td>

                        <!-- Enrolled -->
                        <td><input type="number" id="enr_b" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td><input type="number" id="enr_g" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td id="enr_t" style="background:#eee; font-weight:bold;">0</td>

                        <!-- Present -->
                        <td><input type="number" id="pre_b" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td><input type="number" id="pre_g" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td id="pre_t" style="background:#eee; font-weight:bold;">0</td>

                        <!-- Success -->
                        <td><input type="number" id="suc_b" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td><input type="number" id="suc_g" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td id="suc_t" style="background:#eee; font-weight:bold;">0</td>

                        <!-- Fail -->
                        <td><input type="number" id="fail_b" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td><input type="number" id="fail_g" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td id="fail_t" style="background:#eee; font-weight:bold;">0</td>

                        <!-- Absent -->
                        <td><input type="number" id="abs_b" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td><input type="number" id="abs_g" class="sub-input" oninput="calcGenRow()" placeholder="0">
                        </td>
                        <td id="abs_t" style="background:#eee; font-weight:bold;">0</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Subjects Stats Table -->
        <h4 style="margin: 15px 0 10px;">ุซุงููุงู: ุฅุญุตุงุก ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ</h4>
        <div class="scroll-hint no-print">
            <span class="swipe-icon">โ๏ธ</span>
            <span>ุงุณุญุจ ูููููู ุฃู ุงููุณุงุฑ ููุดุงูุฏุฉ ุจุงูู ุงูุฌุฏูู</span>
        </div>
        <div style="overflow-x:auto;">
            <table id="subjects-table" style="min-width: 800px; table-layout: fixed; width: 100%;">
                <colgroup>
                    <col style="width: 100px;"> <!-- ุงููุงุฏุฉ -->
                    <!-- ูุชูุฏููู -->
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <!-- ุญุงุถุฑูู -->
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <!-- ูุงุฌุญูู -->
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <col style="width: 32px;">
                    <!-- ุงููุณุจุฉ -->
                    <col style="width: 35px;">
                </colgroup>
                <thead>
                    <tr>
                        <th rowspan="2">ุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉ</th>
                        <th colspan="3">ุงููุชูุฏููู</th>
                        <th colspan="3">ุงูุญุงุถุฑูู</th>
                        <th colspan="3">ุงููุงุฌุญูู</th>
                        <th rowspan="2">ุงููุณุจุฉ %</th>
                    </tr>
                    <tr>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                        <th>ุจููู</th>
                        <th>ุจูุงุช</th>
                        <th>ุฌููุฉ</th>
                    </tr>
                </thead>
                <tbody id="subjects-body">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>
        </div>

        <button onclick="saveData()" class="action-btn no-print"
            style="width: 100%; margin-top: 20px; font-size: 1.2rem;">๐พ ุญูุธ ุงูุจูุงูุงุช</button>

        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
            <button onclick="prepareOfficialPrint()" class="action-btn no-print"
                style="flex:1; min-width: 150px; background: #2c3e50;">๐จ๏ธ ุทุจุงุนุฉ ุงูุชูุฑูุฑ ุงูุฑุณูู</button>
            <button onclick="exportToExcel()" class="action-btn no-print"
                style="flex:1; min-width: 150px; background: #27ae60;">๐ ุชุตุฏูุฑ Excel</button>
        </div>
    </div>

    <!-- Evaluation Dashboard Screen -->
    <div id="eval-dashboard-screen" style="display:none; padding: 20px; text-align: right;">

        <div class="control-panel no-print" style="margin-bottom: 20px;">
            <button onclick="backToExamGrades()" class="tab-btn" style="background:#95a5a6; color:white;">โฉ๏ธ ุนูุฏุฉ
                ููุงูุชุญุงูุงุช</button>
        </div>

        <div class="print-header-container"
            style="display:flex; justify-content:space-between; align-items:start; margin-bottom:15px;">
            <div style="flex:1; text-align:right; font-size:12px; line-height:1.4; font-weight:bold;">
                ูุญุงูุธุฉ ุงูุฌูุฒุฉ <br> ูุฏูุฑูุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู <br> ุงูุชุนููู ุงูุงุจุชุฏุงุฆู
            </div>
            <div style="flex:2; text-align:center;">
                <div style="font-weight:bold; font-size:1.2rem; text-decoration:underline;">
                    ุฅุญุตุงุก ุงูุชูููู ุงููุจุฏุฆู ูุงูููุงุฆู
                </div>
                <div id="eval-grade-title" style="font-weight:bold; font-size:1.1rem; margin-top:5px;">ุงูุตู ุงูุฃูู
                    ุงูุงุจุชุฏุงุฆู</div>

                <div style="font-weight:bold; font-size:1.1rem; margin-top:5px;">ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ</div>
                <div style="margin-top:5px; font-size:12px;">ูุฏุฑุณุฉ: <span id="eval-print-school-name">...</span></div>
                <div style="margin-top:5px; font-size:12px;">ุงูุนุงู ุงูุฏุฑุงุณู 2025 / 2026</div>
            </div>
            <div style="flex:1; text-align:left;">
                <img src="logo.jpg" style="height:70px; width:auto;" alt="Logo" onerror="this.style.display='none'">
            </div>
        </div>

        <h3 id="eval-form-title" class="no-print" style="text-align: center; color: var(--primary-color);">ุฅุฏุฎุงู ุจูุงูุงุช
            ุงูุชูููู</h3>

        <div style="display: flex; flex-direction: column; gap: 20px;">

            <!-- ุงููุบุฉ ุงูุนุฑุจูุฉ -->
            <div class="eval-subject-card"
                style="background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <h4 style="border-right: 4px solid #27ae60; padding-right: 10px; color: #27ae60;">ุงููุบุฉ ุงูุนุฑุจูุฉ</h4>
                <div style="overflow-x:auto;">
                    <table class="eval-table"
                        style="width:100%; border-collapse:collapse; margin-top:10px; table-layout: fixed;">
                        <colgroup>
                            <col style="width: 100px;"> <!-- ุงูุตู -->
                            <col style="width: 70px;"> <!-- ูููุฏ -->
                            <col style="width: 70px;"> <!-- ุบุงุฆุจ -->
                            <col style="width: 70px;"> <!-- ุญุงุถุฑ -->
                            <col style="width: 150px;"> <!-- ูุฌูุฏ -->
                            <col style="width: 150px;"> <!-- ูุญุชุงุฌ ุฏุนู -->
                        </colgroup>
                        <thead>
                            <tr style="background:#f0f0f0;">
                                <th>ุงูุตู</th>
                                <th>ูููุฏ</th>
                                <th>ุบุงุฆุจ</th>
                                <th>ุญุงุถุฑ</th>
                                <th>ุญุงุถุฑ 60% ูุฃูุซุฑ (ูุฌูุฏ)</th>
                                <th>ุญุงุถุฑ ุฃูู ูู 60% (ูุญุชุงุฌ ุฏุนู)</th>
                            </tr>
                        </thead>
                        <tbody id="arabic-eval-body">
                            <!-- Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ุงูุฑูุงุถูุงุช -->
            <div class="eval-subject-card"
                style="background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <h4 style="border-right: 4px solid #2980b9; padding-right: 10px; color: #2980b9;">ุงูุฑูุงุถูุงุช</h4>
                <div style="overflow-x:auto;">
                    <table class="eval-table"
                        style="width:100%; border-collapse:collapse; margin-top:10px; table-layout: fixed;">
                        <colgroup>
                            <col style="width: 100px;"> <!-- ุงูุตู -->
                            <col style="width: 70px;"> <!-- ูููุฏ -->
                            <col style="width: 70px;"> <!-- ุบุงุฆุจ -->
                            <col style="width: 70px;"> <!-- ุญุงุถุฑ -->
                            <col style="width: 150px;"> <!-- ูุฌูุฏ -->
                            <col style="width: 150px;"> <!-- ูุญุชุงุฌ ุฏุนู -->
                        </colgroup>
                        <thead>
                            <tr style="background:#f0f0f0;">
                                <th>ุงูุตู</th>
                                <th>ูููุฏ</th>
                                <th>ุบุงุฆุจ</th>
                                <th>ุญุงุถุฑ</th>
                                <th>ุญุงุถุฑ 60% ูุฃูุซุฑ (ูุฌูุฏ)</th>
                                <th>ุญุงุถุฑ ุฃูู ูู 60% (ูุญุชุงุฌ ุฏุนู)</th>
                            </tr>
                        </thead>
                        <tbody id="math-eval-body">
                            <!-- Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ุงููุบุฉ ุงูุฅูุฌููุฒูุฉ -->
            <div class="eval-subject-card"
                style="background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <h4 class="subject-header"
                    style="border-right: 4px solid #e74c3c; padding-right: 10px; color: #e74c3c;">ุงููุบุฉ ุงูุฅูุฌููุฒูุฉ</h4>
                <div style="overflow-x:auto;">
                    <table class="eval-table"
                        style="width:100%; border-collapse:collapse; margin-top:10px; table-layout: fixed;">
                        <colgroup>
                            <col style="width: 100px;"> <!-- ุงูุตู -->
                            <col style="width: 70px;"> <!-- ูููุฏ -->
                            <col style="width: 70px;"> <!-- ุบุงุฆุจ -->
                            <col style="width: 70px;"> <!-- ุญุงุถุฑ -->
                            <col style="width: 150px;"> <!-- ูุฌูุฏ -->
                            <col style="width: 150px;"> <!-- ูุญุชุงุฌ ุฏุนู -->
                        </colgroup>
                        <thead>
                            <tr style="background:#f0f0f0;">
                                <th>ุงูุตู</th>
                                <th>ูููุฏ</th>
                                <th>ุบุงุฆุจ</th>
                                <th>ุญุงุถุฑ</th>
                                <th>ุญุงุถุฑ 60% ูุฃูุซุฑ (ูุฌูุฏ)</th>
                                <th>ุญุงุถุฑ ุฃูู ูู 60% (ูุญุชุงุฌ ุฏุนู)</th>
                            </tr>
                        </thead>
                        <tbody id="english-eval-body">
                            <!-- Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Signature Block for Eval Report -->
            <div class="print-footer-container"
                style="display:none; justify-content:space-around; margin-top:30px; font-weight:bold;">
                <div style="text-align:center;">
                    <div>ูุฏูุฑ ุงููุฑุญูุฉ</div>
                    <div style="margin-top:40px; border-top:1.5px solid #000; min-width:180px;">ุงูุงุณู ูุงูุชูููุน</div>
                </div>
                <div style="text-align:center;">
                    <div>ูุฏูุฑ ุงููุฏุฑุณุฉ</div>
                    <div style="margin-top:40px; border-top:1.5px solid #000; min-width:180px;">ุงูุงุณู ูุงูุชูููุน</div>
                </div>
            </div>

        </div>

        <div style="margin-top: 30px; display:flex; gap: 10px; justify-content:center;">
            <button onclick="saveEvalData()" class="action-btn no-print" style="background:var(--primary-color);">๐พ ุญูุธ
                ุจูุงูุงุช ุงูุชูููู</button>
            <button onclick="printEvalReport()" class="action-btn no-print" style="background:#2c3e50;">๐จ๏ธ ุทุจุงุนุฉ
                ุงูุชูุฑูุฑ</button>
            <button onclick="exportEvalToExcel()" class="action-btn no-print" style="background:#27ae60;">๐ฅ ุชุตุฏูุฑ
                Excel</button>
        </div>

    </div>

    <!-- Official Print Area for Schools (Isolated) -->
    <div id="school-print-area" class="print-only"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
    <link rel="stylesheet" href="https://printjs-4de6.kxcdn.com/print.min.css">

    <script>
        // *** NEW URL ***
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxRzMU_HC595ZhWg__yzRjruHCpS3eMwgJLFoE1eJlUaLQ7G7hgFJRh_oh3NyeNRP3A/exec";

        let currentSchool = {};
        let currentGrade = 3;
        let allSchoolsData = [];

        // Eval Variables
        let currentEvalGrade = 1;
        const evalSubjects = ['arabic', 'math', 'english'];
        const evalSubjectsNames = { 'arabic': 'ูุบุฉ ุนุฑุจูุฉ', 'math': 'ุฑูุงุถูุงุช', 'english': 'ูุบุฉ ุฅูุฌููุฒูุฉ' };

        const subjectsConfig = {
            3: ["ุชุฑุจูุฉ ุฏูููุฉ", "ูุบุฉ ุนุฑุจูุฉ", "ูุบุฉ ุงูุฌููุฒูุฉ", "ุฑูุงุถูุงุช"],
            4: ["ุชุฑุจูุฉ ุฏูููุฉ", "ูุบุฉ ุนุฑุจูุฉ", "ูุบุฉ ุงูุฌููุฒูุฉ", "ุฑูุงุถูุงุช", "ุนููู", "ุฏุฑุงุณุงุช", "ุชูููููุฌูุง ุงููุนูููุงุช ICT"],
            5: ["ุชุฑุจูุฉ ุฏูููุฉ", "ูุบุฉ ุนุฑุจูุฉ", "ูุบุฉ ุงูุฌููุฒูุฉ", "ุฑูุงุถูุงุช", "ุนููู", "ุฏุฑุงุณุงุช", "ุชูููููุฌูุง ุงููุนูููุงุช ICT"],
            6: ["ุชุฑุจูุฉ ุฏูููุฉ", "ูุบุฉ ุนุฑุจูุฉ", "ูุบุฉ ุงูุฌููุฒูุฉ", "ุฑูุงุถูุงุช", "ุนููู", "ุฏุฑุงุณุงุช", "ุชูููููุฌูุง ุงููุนูููุงุช ICT"]
        };

        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        window.onload = function () {
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getSchools" })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        allSchoolsData = data.schools;
                        populateTypes();
                        document.getElementById('loading-schools').style.display = 'none';
                        document.getElementById('login-form-area').style.display = 'block';
                    }
                })
                .catch(err => {
                    document.getElementById('loading-schools').innerHTML = `ุฎุทุฃ ูู ุงูุงุชุตุงู: ${err.message}`;
                });
        };

        function populateTypes() {
            const typeSelect = document.getElementById('schoolTypeSelect');
            const types = [...new Set(allSchoolsData.map(s => s.type))];
            types.forEach(type => {
                let opt = document.createElement('option');
                opt.value = type;
                opt.innerText = type;
                typeSelect.appendChild(opt);
            });
        }

        function filterSchools() {
            const selectedType = document.getElementById('schoolTypeSelect').value;
            const nameSelect = document.getElementById('schoolNameSelect');
            nameSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุฏุฑุณุฉ...</option>';
            const filtered = allSchoolsData.filter(s => s.type === selectedType);
            filtered.forEach(s => {
                let opt = document.createElement('option');
                opt.value = s.name;
                opt.innerText = s.name;
                nameSelect.appendChild(opt);
            });
        }

        function login() {
            var schoolType = document.getElementById('schoolTypeSelect').value;
            var schoolName = document.getElementById('schoolNameSelect').value;
            var password = document.getElementById('schoolCode').value;

            if (!schoolType || !schoolName || !password) {
                Swal.fire('ุชูุจูู', 'ุจูุงูุงุช ุงูุฏุฎูู ูุงูุตุฉ', 'warning');
                return;
            }

            const btn = document.querySelector('.login-btn');
            const originalText = btn.innerText;
            btn.innerText = "ุฌุงุฑู ุงูุฏุฎูู...";
            btn.disabled = true;

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "login",
                    schoolName: schoolName,
                    schoolType: schoolType,
                    password: password
                })
            })
                .then(res => res.json())
                .then(data => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                    if (data.status === "success") {
                        currentSchool = data.schoolData; // Has ID from Col E
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('dashboard-screen').style.display = 'block';

                        document.getElementById('ui-school-name').innerText = currentSchool.name;
                        document.getElementById('ui-school-type').innerText = currentSchool.type;
                        document.getElementById('print-school-name').innerText = currentSchool.name;
                        document.getElementById('eval-print-school-name').innerText = currentSchool.name;

                        showGrade(3);
                    } else {
                        Swal.fire('ุฎุทุฃ', data.message, 'error');
                    }
                })
                .catch(err => Swal.fire('ุฎุทุฃ', err.message, 'error'));
        }

        /* --- Admin Logic --- */
        function showAdminLogin() { document.getElementById('admin-login-modal').style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function submitAdminLogin() {
            const pass = document.getElementById('admin-pass-input').value;
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "adminLogin", password: pass })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        document.getElementById('admin-login-modal').style.display = 'none';
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('admin-dashboard-screen').style.display = 'block';
                        loadAdminStats(3);
                    } else {
                        Swal.fire('ุฎุทุฃ', 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ', 'error');
                    }
                });
        }

        function logout() { location.reload(); }
        function logoutAdmin() { location.reload(); }
        function showPasswordModal() { document.getElementById('password-modal').style.display = 'block'; }

        function changePassword() {
            var schoolType = document.getElementById('schoolTypeSelect').value;
            var schoolName = document.getElementById('schoolNameSelect').value;
            var newPass = document.getElementById('new-pass').value;

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "changePassword", schoolName: schoolName, schoolType: schoolType, newPass: newPass })
            }).then(res => res.json()).then(data => {
                if (data.status === "success") { Swal.fire('ุชู', data.message, 'success'); closeModal('password-modal'); }
            });
        }
        function validateNumberInput(input) { input.value = input.value.replace(/[^0-9]/g, ''); }

        /* --- Admin Dashboard Logic --- */
        function switchAdminView(view) {
            document.getElementById('admin-view-reports').style.display = view === 'reports' ? 'block' : 'none';
            document.getElementById('admin-view-status').style.display = view === 'status' ? 'block' : 'none';
            document.getElementById('btn-view-reports').classList.toggle('active', view === 'reports');
            document.getElementById('btn-view-status').classList.toggle('active', view === 'status');
        }

        function loadAdminStats(grade) {
            currentGrade = grade;
            const gradeText = grade == 3 ? 'ุงูุซุงูุซ' : grade == 4 ? 'ุงูุฑุงุจุน' : grade == 5 ? 'ุงูุฎุงูุณ' : 'ุงูุณุงุฏุณ';
            const adminGradeTitle = document.getElementById('admin-grade-title');
            if (adminGradeTitle) adminGradeTitle.innerText = `ุงูุตู ${gradeText} ุงูุงุจุชุฏุงุฆู`;

            document.querySelectorAll('#admin-dashboard-screen .tabs .tab-btn').forEach(b => b.classList.remove('active'));
            const btns = document.querySelectorAll('#admin-dashboard-screen .tabs button');
            btns.forEach(b => {
                if (b.innerText.includes(grade + " ุงุจุชุฏุงุฆู") && !b.innerText.includes("ุชูููู")) b.classList.add('active');
            });

            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "getAdminStats", grade: grade }) })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success" && data.aggregation) {
                        lastAdminData = data.aggregation; // Crucial for Excel export
                        renderAdminTables(data.aggregation, grade);
                    } else {
                        Swal.fire('ุชูุจูู', data.message || "ูุง ุชูุฌุฏ ุจูุงูุงุช ููุฐุง ุงูุตู ุจุนุฏ.", 'info');
                        const container = document.getElementById('admin-view-reports');
                        if (container) container.innerHTML = "<p style='text-align:center; padding:20px;'>ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุงุญุฉ ููุฐุง ุงูุตู.</p>";
                    }
                })
                .catch(err => Swal.fire('ุฎุทุฃ', 'ูุดู ุชุญููู ุงูุจูุงูุงุช: ' + err.message, 'error'));
        }

        function loadAdminEvalStats(grade) {
            currentEvalGrade = grade;
            const gradeText = grade == 1 ? 'ุงูุฃูู' : 'ุงูุซุงูู';
            document.getElementById('admin-grade-title').innerText = `ุฅุญุตุงุก ุชูููู ุงูุตู ${gradeText}`;

            document.querySelectorAll('#admin-dashboard-screen .tabs .tab-btn').forEach(b => b.classList.remove('active'));
            const btns = document.querySelectorAll('#admin-dashboard-screen .tabs button');
            btns.forEach(b => { if (b.innerText.includes(grade + " ุงุจุชุฏุงุฆู") && b.innerText.includes("ุชูููู")) b.classList.add('active'); });

            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "getAdminEvalStats", grade: grade }) })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success" && data.aggregation) {
                        renderAdminEvalTables(data.aggregation, grade);
                        document.getElementById('count-submitted').innerText = data.aggregation.submittedSchools.length;
                        document.getElementById('count-missing').innerText = data.aggregation.missingSchools.length;
                        document.getElementById('list-submitted').innerHTML = data.aggregation.submittedSchools.map(s => `<li>${s}</li>`).join("");
                        document.getElementById('list-missing').innerHTML = data.aggregation.missingSchools.map(s => `<li>${s}</li>`).join("");
                    }
                });
        }

        function renderAdminTables(data, grade, isIndividual = false) {
            try {
                if (!isIndividual) lastAdminData = data;

                const adminArea = isIndividual ? document.getElementById('school-print-area') : document.getElementById('admin-view-reports');
                if (!adminArea) return;

                adminArea.innerHTML = "";
                const subjects = subjectsConfig[grade];

                const types = isIndividual ? ["target"] : ["ุฑุณูู ุนุฑุจู", "ุฑุณูู ูุบุงุช", "ุฎุงุต ุนุฑุจู", "ุฎุงุต ูุบุงุช", "ุฏููู", "ูุฌููุน"];
                const typeLabels = {
                    "ุฑุณูู ุนุฑุจู": "ูุฏุงุฑุณ ุฑุณูู ุนุฑุจู", "ุฑุณูู ูุบุงุช": "ูุฏุงุฑุณ ุฑุณูู ูุบุงุช",
                    "ุฎุงุต ุนุฑุจู": "ูุฏุงุฑุณ ุฎุงุต ุนุฑุจู", "ุฎุงุต ูุบุงุช": "ูุฏุงุฑุณ ุฎุงุต ูุบุงุช",
                    "ุฏููู": "ูุฏุงุฑุณ ุฏููู", "ูุฌููุน": "ุงูุฅุฌูุงูู",
                    "target": currentSchool ? currentSchool.name : "ุงููุฏุฑุณุฉ"
                };
                const typeLabels2 = {
                    "ุฑุณูู ุนุฑุจู": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฑุณููุฉ ุนุฑุจู", "ุฑุณูู ูุบุงุช": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฑุณููุฉ ูุบุงุช",
                    "ุฎุงุต ุนุฑุจู": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฎุงุตุฉ ุนุฑุจู", "ุฎุงุต ูุบุงุช": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฎุงุตุฉ ูุบุงุช",
                    "ุฏููู": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฏูููุฉ", "ูุฌููุน": "ุงูุฌููุฉ ุงูุนุงูุฉ ููุฅุฏุงุฑุฉ",
                    "target": currentSchool ? currentSchool.name : "ุจูุงูุงุช ุงููุฏุฑุณุฉ"
                };

                let html = ``;

                const headerHtml = (formNum) => `
                    <div class="print-header-container" style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                        <div style="flex:1; text-align:right; font-size:12px; line-height:1.4; font-weight:bold;">
                            ูุญุงูุธุฉ ุงูุฌูุฒุฉ <br> ูุฏูุฑูุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู <br> ุงูุชุนููู ุงูุงุจุชุฏุงุฆู
                        </div>
                        <div style="flex:2; text-align:center;">
                            <div style="font-weight:bold; font-size:1.1rem; text-decoration:underline;">
                                ุจูุงู ุฅุญุตุงุฆู ${grade == 3 ? 'ุงูุตู ุงูุซุงูุซ' : grade == 4 ? 'ุงูุตู ุงูุฑุงุจุน' : grade == 5 ? 'ุงูุตู ุงูุฎุงูุณ' : 'ุงูุตู ุงูุณุงุฏุณ'} ุงูุงุจุชุฏุงุฆู
                            </div>
                            <div style="font-weight:bold; font-size:1.2rem; margin-top:5px;">ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ</div>
                            ${isIndividual && currentSchool ? `<div style="font-weight:bold; font-size:1.1rem; margin-top:5px;">ูุฏุฑุณุฉ / ${currentSchool.name}</div>` : ''}
                            <div style="margin-top:5px; font-size:12px;">ุนู ุงูุชุญุงู ูุตู ุงูุนุงู ุงูุฏุฑุงุณู 2025 / 2026</div>
                            <div style="font-size:11px; margin-top:5px; font-weight:bold;">ุงุณุชูุงุฑุฉ ุฑูู ( ${formNum} )</div>
                        </div>
                        <div style="flex:1; text-align:left;">
                            <img src="logo.jpg" style="height:70px; width:auto;" alt="Logo" onerror="this.style.display='none'">
                        </div>
                    </div>
                `;

                const footerHtml = `
                    <div class="print-footer-container" style="display:flex; justify-content:space-around; margin-top:35px; font-weight:bold;">
                        <div style="text-align:center;">
                            <div>${isIndividual ? 'ุฑุฆูุณ ูุฌูุฉ ุงููุธุงู ูุงููุฑุงูุจุฉ' : 'ูุฏูุฑ ุงููุฑุญูุฉ'}</div>
                            <div style="margin-top:45px; border-top:1.5px solid #000; min-width:180px;"></div>
                        </div>
                        <div style="text-align:center;">
                            <div>${isIndividual ? 'ูุฏูุฑ ุงููุฏุฑุณุฉ' : 'ูุฏูุฑ ุนุงู ุงูุฅุฏุงุฑุฉ'}</div>
                            <div style="margin-top:45px; border-top:1.5px solid #000; min-width:180px;"></div>
                        </div>
                    </div>
                `;

                // --- SHEET 1: GENERAL STATS ---
                html += `<div class="admin-sheet-container">`;
                html += headerHtml('1');
                html += `
                    <table class="admin-table-official" style="table-layout: fixed; width: 100%;">
                        <colgroup>
                            <col style="width: 150px;"> <!-- ููุน ุงูุชุนููู -->
                            <col style="width: 50px;">  <!-- ุงููุฏุงุฑุณ -->
                            <!-- 15 Columns for numeric data -->
                            <col style="width: 50px;"><col style="width: 50px;"><col style="width: 50px;">
                            <col style="width: 50px;"><col style="width: 50px;"><col style="width: 50px;">
                            <col style="width: 50px;"><col style="width: 50px;"><col style="width: 50px;">
                            <col style="width: 50px;"><col style="width: 50px;"><col style="width: 50px;">
                            <col style="width: 50px;"><col style="width: 50px;"><col style="width: 50px;">
                        </colgroup>
                        <thead>
                            <tr>
                                <th rowspan="2" class="col-label">${isIndividual ? 'ุงููุฏุฑุณุฉ' : 'ููุน ุงูุชุนููู'}</th>
                                <th rowspan="2">ุงููุฏุงุฑุณ</th>
                                <th colspan="3">ุงููููุฏ</th>
                                <th colspan="3">ุงูุญุงุถุฑ</th>
                                <th colspan="3">ุงููุงุฌุญ (50% ูุฃูุซุฑ)</th>
                                <th colspan="3">ุงูุฑุงุณุจ (ุฃูู ูู 50%)</th>
                                <th colspan="3">ุงูุบุงุฆุจ</th>
                            </tr>
                            <tr>
                                <th>ุจููู</th><th>ุจูุงุช</th><th>ุฌููุฉ</th>
                                <th>ุจููู</th><th>ุจูุงุช</th><th>ุฌููุฉ</th>
                                <th>ุจููู</th><th>ุจูุงุช</th><th>ุฌููุฉ</th>
                                <th>ุจููู</th><th>ุจูุงุช</th><th>ุฌููุฉ</th>
                                <th>ุจููู</th><th>ุจูุงุช</th><th>ุฌููุฉ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let statsSource = data ? data.stats : {};
                types.forEach(type => {
                    let d = statsSource[type] || {};
                    const v = (k) => d[k] || 0;
                    html += `<tr>
                        <td class="col-label">${typeLabels[type]}</td>
                        <td>${isIndividual ? '1' : (v('schoolsCount') || '')}</td>
                        <td>${v('enrolledB')}</td><td>${v('enrolledG')}</td><td>${v('enrolledT')}</td>
                        <td>${v('presentB')}</td><td>${v('presentG')}</td><td>${v('presentT')}</td>
                        <td>${v('successB')}</td><td>${v('successG')}</td><td>${v('successT')}</td>
                        <td>${v('failB')}</td><td>${v('failG')}</td><td>${v('failT')}</td>
                        <td>${v('absentB')}</td><td>${v('absentG')}</td><td>${v('absentT')}</td>
                    </tr>`;
                });

                html += `</tbody></table>`;
                html += `</div>`; // End Sheet 1

                // --- SHEET 2: SUBJECT STATS ---
                html += `<div class="admin-sheet-container">`;
                html += `<h4 style="text-align:center; margin-bottom:10px; text-decoration:underline; font-size:1.2rem;">ุซุงููุงู: ุฅุญุตุงุก ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ</h4>`;
                html += `
                    <table class="admin-table-official" style="table-layout: fixed; width: 100%;">
                        <colgroup>
                            <col style="width: 150px;"> <!-- ูุฏุฑุณุฉ / ููุนูุฉ -->
                            <col style="width: 60px;">  <!-- ูููุฏ -->
                            ${subjects.map(() => `<col style="width: 45px;"><col style="width: 45px;"><col style="width: 45px;">`).join('')}
                        </colgroup>
                        <thead>
                            <tr>
                                <th rowspan="2" class="col-label">${isIndividual ? 'ุงููุฏุฑุณุฉ' : 'ููุนูุฉ ุงูุชุนููู'}</th>
                                <th rowspan="2">ุงููููุฏ</th>
                                ${subjects.map(s => `<th colspan="3" style="font-size: 9pt;">${s}</th>`).join('')}
                            </tr>
                            <tr>
                                ${subjects.map(() => `<th>ุญุงุถุฑ</th><th>ูุงุฌุญ</th><th>ุฑุงุณุจ</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;

                types.forEach(type => {
                    let d = statsSource[type] || {};
                    let enrollmentTotal = d.enrolledT || 0;
                    let subjStats = d.subjectStats || [];
                    html += `<tr>
                        <td style="text-align:right; padding-right:10px; font-weight:bold;">${isIndividual ? typeLabels[type] : typeLabels2[type]}</td>
                        <td style="background:#f9f9f9; font-weight:bold;">${enrollmentTotal}</td>
                        ${subjects.map((_, idx) => {
                        let idx8 = idx * 8;
                        let idx3 = idx * 3;

                        let isNewStats = subjStats.length > (subjects.length * 4);

                        let tPre, tSuc, tFail;
                        if (isNewStats) {
                            let base = idx * 8;
                            tPre = (subjStats[base + 2] || 0) + (subjStats[base + 3] || 0);
                            tSuc = (subjStats[base + 4] || 0) + (subjStats[base + 5] || 0);
                            tFail = (subjStats[base + 6] || 0) + (subjStats[base + 7] || 0);
                        } else {
                            let base = idx * 3;
                            tPre = subjStats[base] || 0;
                            tSuc = subjStats[base + 1] || 0;
                            tFail = subjStats[base + 2] || 0;
                        }
                        return `<td>${tPre}</td><td>${tSuc}</td><td>${tFail}</td>`;
                    }).join('')}
                    </tr>`;
                });

                html += `</tbody></table>`;
                html += footerHtml;
                html += `</div>`; // End Sheet 2

                adminArea.innerHTML = html;

                if (!isIndividual && data) {
                    // Update status view
                    const listSub = document.getElementById('list-submitted');
                    const listMis = document.getElementById('list-missing');
                    if (listSub && listMis) {
                        listSub.innerHTML = ""; listMis.innerHTML = "";
                        const sub = data.submittedSchools || [];
                        const mis = data.missingSchools || [];
                        const subCount = document.getElementById('count-submitted');
                        const misCount = document.getElementById('count-missing');
                        if (subCount) subCount.innerText = sub.length;
                        if (misCount) misCount.innerText = mis.length;
                        sub.forEach(s => listSub.innerHTML += `<li>โ ${s.name || s}</li>`);
                        mis.forEach(s => listMis.innerHTML += `<li>โ ${s.name || s}</li>`);
                    }
                }
            } catch (e) {
                console.error("Render Error:", e);
            }
        }

        function renderAdminEvalTables(data, grade) {
            const container = document.getElementById('admin-view-reports');
            container.innerHTML = "";
            for (const type in data.stats) {
                const s = data.stats[type];
                if (s.schoolsCount === 0 && type !== 'ูุฌููุน') continue;

                let table = `<div class="report-section">
                    <h3>ุฅุญุตุงุก ุชูููู ${type} (${s.schoolsCount} ูุฏุฑุณุฉ)</h3>
                    <table class="admin-table-official">
                        <thead><tr><th rowspan="2">ุงููุงุฏุฉ</th><th colspan="3">ุฅุญุตุงุก ุงูุทูุงุจ</th><th colspan="2">ุงูุชูููู</th></tr>
                            <tr><th>ูููุฏ</th><th>ุบุงุฆุจ</th><th>ุญุงุถุฑ</th><th>60% ูุฃูุซุฑ (ุฌูุฏ)</th><th>ุฃูู ูู 60%</th></tr></thead>
                        <tbody>
                            <tr><td>ูุบุฉ ุนุฑุจูุฉ</td><td>${s.arabic.enrolled}</td><td>${s.arabic.absent}</td><td>${s.arabic.present}</td><td>${s.arabic.pass60}</td><td>${s.arabic.less60}</td></tr>
                            <tr><td>ุฑูุงุถูุงุช</td><td>${s.math.enrolled}</td><td>${s.math.absent}</td><td>${s.math.present}</td><td>${s.math.pass60}</td><td>${s.math.less60}</td></tr>
                            <tr><td>ูุบุฉ ุฅูุฌููุฒูุฉ</td><td>${s.english.enrolled}</td><td>${s.english.absent}</td><td>${s.english.present}</td><td>${s.english.pass60}</td><td>${s.english.less60}</td></tr>
                        </tbody>
                    </table>
                </div>`;
                container.innerHTML += table;
            }
        }

        function printAdminReport() {
            document.body.classList.add('print-mode-admin');
            window.print();
            setTimeout(() => document.body.classList.remove('print-mode-admin'), 1000);
        }

        function exportAdminToExcel() {
            if (!lastAdminData) {
                Swal.fire('ุฎุทุฃ', 'ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุตุฏูุฑูุง. ูุฑุฌู ุชุญููู ุงูุฌุฏูู ุฃููุงู.', 'warning');
                return;
            }

            const grade = currentGrade;
            const subjects = subjectsConfig[grade];
            const types = ["ุฑุณูู ุนุฑุจู", "ุฑุณูู ูุบุงุช", "ุฎุงุต ุนุฑุจู", "ุฎุงุต ูุบุงุช", "ุฏููู", "ูุฌููุน"];
            const typeLabels = {
                "ุฑุณูู ุนุฑุจู": "ูุฏุงุฑุณ ุฑุณูู ุนุฑุจู", "ุฑุณูู ูุบุงุช": "ูุฏุงุฑุณ ุฑุณูู ูุบุงุช",
                "ุฎุงุต ุนุฑุจู": "ูุฏุงุฑุณ ุฎุงุต ุนุฑุจู", "ุฎุงุต ูุบุงุช": "ูุฏุงุฑุณ ุฎุงุต ูุบุงุช",
                "ุฏููู": "ูุฏุงุฑุณ ุฏููู", "ูุฌููุน": "ุงูุฅุฌูุงูู"
            };
            const typeLabels2 = {
                "ุฑุณูู ุนุฑุจู": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฑุณููุฉ ุนุฑุจู", "ุฑุณูู ูุบุงุช": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฑุณููุฉ ูุบุงุช",
                "ุฎุงุต ุนุฑุจู": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฎุงุตุฉ ุนุฑุจู", "ุฎุงุต ูุบุงุช": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฎุงุตุฉ ูุบุงุช",
                "ุฏููู": "ุฌููุฉ ุงููุฏุงุฑุณ ุงูุฏูููุฉ", "ูุฌููุน": "ุงูุฌููุฉ ุงูุนุงูุฉ ููุฅุฏุงุฑุฉ"
            };

            const wb = XLSX.utils.book_new();

            // --- General Stats (Sheet 1) ---
            const genRows = [];
            genRows.push(["ุจูุงู ุฅุญุตุงุฆู ( ุงุณุชูุงุฑุฉ 1 ) - ุงูุตู " + grade + " ุงูุงุจุชุฏุงุฆู - ูุตู ุงูุนุงู 2026"]);
            genRows.push(["ููุน ุงูุชุนููู", "ุนุฏุฏ ุงููุฏุงุฑุณ", "ุงููููุฏ", "", "", "ุงูุญุงุถุฑ", "", "", "50% ูุฃูุซุฑ", "", "", "ุฃูู ูู 50 %", "", "", "ุงูุบุงุฆุจ", "", ""]);
            genRows.push(["", "", "ุจููู", "ุจูุงุช", "ุฌููุฉ", "ุจููู", "ุจูุงุช", "ุฌููุฉ", "ุจููู", "ุจูุงุช", "ุฌููุฉ", "ุจููู", "ุจูุงุช", "ุฌููุฉ", "ุจููู", "ุจูุงุช", "ุฌููุฉ"]);

            types.forEach(type => {
                let d = lastAdminData.stats[type] || {};
                const v = (k) => d[k] || 0;
                genRows.push([
                    typeLabels[type], (type === "ูุฌููุน" ? "" : v('schoolsCount')),
                    v('enrolledB'), v('enrolledG'), v('enrolledT'),
                    v('presentB'), v('presentG'), v('presentT'),
                    v('successB'), v('successG'), v('successT'),
                    v('failB'), v('failG'), v('failT'),
                    v('absentB'), v('absentG'), v('absentT')
                ]);
            });

            const wsGen = XLSX.utils.aoa_to_sheet(genRows);
            wsGen['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 16 } },
                { s: { r: 1, c: 0 }, e: { r: 2, c: 0 } },
                { s: { r: 1, c: 1 }, e: { r: 2, c: 1 } },
                { s: { r: 1, c: 2 }, e: { r: 1, c: 4 } },
                { s: { r: 1, c: 5 }, e: { r: 1, c: 7 } },
                { s: { r: 1, c: 8 }, e: { r: 1, c: 10 } },
                { s: { r: 1, c: 11 }, e: { r: 1, c: 13 } },
                { s: { r: 1, c: 14 }, e: { r: 1, c: 16 } }
            ];

            // --- Subject Stats (Sheet 2) ---
            const subjRows = [];
            subjRows.push(["ุจูุงู ุฅุญุตุงุฆู ( ุงุณุชูุงุฑุฉ 2 ) - ุงูุตู " + grade + " ุงูุงุจุชุฏุงุฆู"]);
            const head1 = ["ููุนูุฉ ุงูุชุนููู", "ุงููููุฏ"];
            subjects.forEach(s => { head1.push(s, "", ""); });
            subjRows.push(head1);
            const head2 = ["", ""];
            subjects.forEach(() => { head2.push("ุญุงุถุฑ", "ุงูุซุฑ", "ุงูู"); });
            subjRows.push(head2);

            types.forEach(type => {
                let d = lastAdminData.stats[type] || {};
                let enrollmentTotal = d.enrolledT || 0;
                let subjStats = d.subjectStats || [];
                const row = [typeLabels2[type], enrollmentTotal];
                subjects.forEach((_, idx) => {
                    let isNewStats = subjStats.length > (subjects.length * 4);
                    let tPre, tSuc, tFail;
                    if (isNewStats) {
                        let base = idx * 8;
                        tPre = (subjStats[base + 2] || 0) + (subjStats[base + 3] || 0);
                        tSuc = (subjStats[base + 4] || 0) + (subjStats[base + 5] || 0);
                        tFail = (subjStats[base + 6] || 0) + (subjStats[base + 7] || 0);
                    } else {
                        let base = idx * 3;
                        tPre = subjStats[base] || 0;
                        tSuc = subjStats[base + 1] || 0;
                        tFail = subjStats[base + 2] || 0;
                    }
                    row.push(tPre, tSuc, tFail);
                });
                subjRows.push(row);
            });

            const wsSubj = XLSX.utils.aoa_to_sheet(subjRows);
            const subjMerges = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 2 + subjects.length * 3 - 1 } }];
            subjMerges.push({ s: { r: 1, c: 0 }, e: { r: 2, c: 0 } });
            subjMerges.push({ s: { r: 1, c: 1 }, e: { r: 2, c: 1 } });
            subjects.forEach((_, i) => {
                let startCol = 2 + (i * 3);
                subjMerges.push({ s: { r: 1, c: startCol }, e: { r: 1, c: startCol + 2 } });
            });
            wsSubj['!merges'] = subjMerges;

            // --- Apply Borders to both Admin Sheets ---
            [wsGen, wsSubj].forEach(ws => {
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        let cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
                        if (!ws[cell_ref]) ws[cell_ref] = { t: 's', v: '' }; // Ensure cell exists
                        ws[cell_ref].s = {
                            border: {
                                top: { style: "thin" }, bottom: { style: "thin" },
                                left: { style: "thin" }, right: { style: "thin" }
                            },
                            alignment: { vertical: "center", horizontal: "center", wrapText: true }
                        };
                        // Bold Headers
                        if (R < 3) ws[cell_ref].s.font = { bold: true };
                    }
                }
            });

            XLSX.utils.book_append_sheet(wb, wsGen, "ุฅุญุตุงุก ุนุงู (1)");
            XLSX.utils.book_append_sheet(wb, wsSubj, "ุฅุญุตุงุก ุงูููุงุฏ (2)");

            XLSX.writeFile(wb, `GizaStats_Grade${grade}.xlsx`);
        }

        function prepareOfficialPrint() {
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "getSchoolStats", grade: currentGrade, schoolId: currentSchool.id }) })
                .then(res => res.json())
                .then(data => {
                    if (data.hasData) {
                        const dummyAgg = {
                            stats: {
                                "target": {
                                    schoolsCount: 1,
                                    enrolledB: data.statsData[1], enrolledG: data.statsData[2], enrolledT: data.statsData[3],
                                    presentB: data.statsData[4], presentG: data.statsData[5], presentT: data.statsData[6],
                                    successB: data.statsData[7], successG: data.statsData[8], successT: data.statsData[9],
                                    failB: data.statsData[10], failG: data.statsData[11], failT: data.statsData[12],
                                    absentB: data.statsData[13], absentG: data.statsData[14], absentT: data.statsData[15],
                                    subjectStats: data.statsData.slice(17)
                                }
                            }
                        };
                        renderAdminTables(dummyAgg, currentGrade, true);
                        document.body.classList.add('print-mode-official');
                        window.print();
                        setTimeout(() => document.body.classList.remove('print-mode-official'), 1000);
                    }
                });
        }


        // --- Dashboard Logic ---
        function showGrade(grade) {
            currentGrade = grade;
            const gradeText = grade == 3 ? 'ุงูุซุงูุซ' : grade == 4 ? 'ุงูุฑุงุจุน' : grade == 5 ? 'ุงูุฎุงูุณ' : 'ุงูุณุงุฏุณ';

            // Switch views
            document.getElementById('eval-dashboard-screen').style.display = 'none';
            document.getElementById('dashboard-screen').style.display = 'block';

            document.getElementById('grade-title').innerText = `ุงูุตู ${gradeText} ุงูุงุจุชุฏุงุฆู`;
            document.getElementById('print-title').innerText = `ุฅุญุตุงุก ูุชูุฌุฉ ุงูุชุญุงู ุงูุตู ${gradeText} ูุงูุชุญุงูุงุช ูุตู ุงูุนุงู 2025 / 2026 ู`;

            const dashboardTabs = document.querySelectorAll('#dashboard-screen .tabs .tab-btn');
            dashboardTabs.forEach(b => b.classList.remove('active'));
            if (dashboardTabs[grade - 1]) dashboardTabs[grade - 1].classList.add('active');

            // CLEAR OLD DATA (Fix for "Stats not updating")
            const inputs = document.querySelectorAll('#dashboard-screen .sub-input');
            inputs.forEach(i => i.value = "");
            const displays = document.querySelectorAll('#dashboard-screen td[id$="_t"]');
            displays.forEach(d => d.innerText = "0");
            document.querySelectorAll('#dashboard-screen td[id^="perc_"]').forEach(d => d.innerText = "0%");

            const tbody = document.getElementById('subjects-body');
            tbody.innerHTML = "";
            subjectsConfig[grade].forEach((subj, index) => {
                let row = `<tr><td style="font-weight:bold; background-color: #fafafa;">${subj}</td>
                    <td><input type="number" id="app_b_${index}" class="sub-input" oninput="calcSubjRow(${index})"></td>
                    <td><input type="number" id="app_g_${index}" class="sub-input" oninput="calcSubjRow(${index})"></td>
                    <td id="app_t_${index}" style="background:#eee;">0</td>
                    <td><input type="number" id="pre_b_${index}" class="sub-input" oninput="calcSubjRow(${index})"></td>
                    <td><input type="number" id="pre_g_${index}" class="sub-input" oninput="calcSubjRow(${index})"></td>
                    <td id="pre_t_${index}" style="background:#eee;">0</td>
                    <td><input type="number" id="suc_b_${index}" class="sub-input" oninput="calcSubjRow(${index})"></td>
                    <td><input type="number" id="suc_g_${index}" class="sub-input" oninput="calcSubjRow(${index})"></td>
                    <td id="suc_t_${index}" style="background:#eee;">0</td>
                    <td id="perc_${index}" style="font-weight:bold; direction:ltr;">0%</td></tr>`;
                tbody.innerHTML += row;
            });
            loadSavedDataForGrade(grade);
        }

        // --- Calc Logic (Brief) ---
        function calcGenRow() {
            let enr_b = parseFloat(document.getElementById('enr_b').value) || 0, enr_g = parseFloat(document.getElementById('enr_g').value) || 0;
            let pre_b = parseFloat(document.getElementById('pre_b').value) || 0, pre_g = parseFloat(document.getElementById('pre_g').value) || 0;
            let suc_b = parseFloat(document.getElementById('suc_b').value) || 0, suc_g = parseFloat(document.getElementById('suc_g').value) || 0;
            document.getElementById('abs_b').value = Math.max(0, enr_b - pre_b);
            document.getElementById('abs_g').value = Math.max(0, enr_g - pre_g);
            document.getElementById('fail_b').value = Math.max(0, pre_b - suc_b);
            document.getElementById('fail_g').value = Math.max(0, pre_g - suc_g);
            ['enr', 'pre', 'suc', 'fail', 'abs'].forEach(f => {
                let b = parseFloat(document.getElementById(`${f}_b`).value) || 0, g = parseFloat(document.getElementById(`${f}_g`).value) || 0;
                document.getElementById(`${f}_t`).innerText = b + g;
            });
        }
        function calcSubjRow(idx) {
            const getV = (id) => parseFloat(document.getElementById(id)?.value) || 0;
            const setT = (id, v) => document.getElementById(id).innerText = v;
            let ab = getV(`app_b_${idx}`), ag = getV(`app_g_${idx}`), pb = getV(`pre_b_${idx}`), pg = getV(`pre_g_${idx}`), sb = getV(`suc_b_${idx}`), sg = getV(`suc_g_${idx}`);
            setT(`app_t_${idx}`, ab + ag); setT(`pre_t_${idx}`, pb + pg); setT(`suc_t_${idx}`, sb + sg);
            let tp = pb + pg, ts = sb + sg;
            setT(`perc_${idx}`, tp > 0 ? ((ts / tp) * 100).toFixed(1) + "%" : "0%");
        }

        function saveData() {
            const check = (cond, msg) => { if (cond) throw new Error(msg); };
            const btn = document.querySelector('button[onclick="saveData()"]');
            if (!btn) return;

            try {
                const getVal = (id, label) => {
                    let el = document.getElementById(id);
                    if (!el) return 0;
                    if (el.value === "") throw new Error(`ุญูู ูุงุฑุบ: ${label} ูุฌุจ ุฅุฏุฎุงู ูููุฉ.`);
                    let v = parseFloat(el.value);
                    if (isNaN(v)) throw new Error(`ูููุฉ ุบูุฑ ุตุญูุญุฉ ูู ${label}`);
                    return v;
                };

                // Validate
                let gEnrB = getVal('enr_b', 'ุงููููุฏ ุจููู');
                let gEnrG = getVal('enr_g', 'ุงููููุฏ ุจูุงุช');
                let gPreB = getVal('pre_b', 'ุงูุญุงุถุฑ ุจููู');
                let gPreG = getVal('pre_g', 'ุงูุญุงุถุฑ ุจูุงุช');
                let gSucB = getVal('suc_b', 'ุงููุงุฌุญ ุจููู');
                let gSucG = getVal('suc_g', 'ุงููุงุฌุญ ุจูุงุช');

                check(gPreB > gEnrB, "ุนุฏุฏ ุงูุญุงุถุฑูู (ุจููู) ูุง ูููู ุฃู ูููู ุฃูุจุฑ ูู ุงููููุฏูู!");
                check(gPreG > gEnrG, "ุนุฏุฏ ุงูุญุงุถุฑูู (ุจูุงุช) ูุง ูููู ุฃู ูููู ุฃูุจุฑ ูู ุงููููุฏูู!");
                check(gSucB > gPreB, "ุนุฏุฏ ุงููุงุฌุญูู (ุจููู) ูุง ูููู ุฃู ูููู ุฃูุจุฑ ูู ุงูุญุงุถุฑูู!");
                check(gSucG > gPreG, "ุนุฏุฏ ุงููุงุฌุญูู (ุจูุงุช) ูุง ูููู ุฃู ูููู ุฃูุจุฑ ูู ุงูุญุงุถุฑูู!");

                subjectsConfig[currentGrade].forEach((subj, idx) => {
                    let appB = getVal(`app_b_${idx}`, `${subj} - ูููุฏ ุจููู`);
                    let appG = getVal(`app_g_${idx}`, `${subj} - ูููุฏ ุจูุงุช`);
                    let preB = getVal(`pre_b_${idx}`, `${subj} - ุญุงุถุฑ ุจููู`);
                    let preG = getVal(`pre_g_${idx}`, `${subj} - ุญุงุถุฑ ุจูุงุช`);
                    let sucB = getVal(`suc_b_${idx}`, `${subj} - 50% ูุฃูุซุฑ ุจููู`);
                    let sucG = getVal(`suc_g_${idx}`, `${subj} - 50% ูุฃูุซุฑ ุจูุงุช`);

                    check(preB > appB, `ูู ูุงุฏุฉ ${subj}: ุนุฏุฏ ุงูุญุงุถุฑูู (ุจููู) ุฃูุจุฑ ูู ุงููููุฏูู!`);
                    check(preG > appG, `ูู ูุงุฏุฉ ${subj}: ุนุฏุฏ ุงูุญุงุถุฑูู (ุจูุงุช) ุฃูุจุฑ ูู ุงููููุฏูู!`);
                    check(sucB > preB, `ูู ูุงุฏุฉ ${subj}: ุนุฏุฏ ุงูุญุงุตููู ุนูู 50% ูุฃูุซุฑ (ุจููู) ุฃูุจุฑ ูู ุงูุญุงุถุฑูู!`);
                    check(sucG > preG, `ูู ูุงุฏุฉ ${subj}: ุนุฏุฏ ุงูุญุงุตููู ุนูู 50% ูุฃูุซุฑ (ุจูุงุช) ุฃูุจุฑ ูู ุงูุญุงุถุฑูู!`);
                });

                btn.innerText = "ุฌุงุฑู ุงูุญูุธ..."; btn.disabled = true;

                // Prepare Data
                const getV = (id) => document.getElementById(id).value || 0;
                const getT = (id) => document.getElementById(id).innerText || 0;
                let stats = [];

                stats.push(1); // Count
                let enrT = getT('enr_t');
                stats.push(getV('enr_b'), getV('enr_g'), enrT);
                stats.push(getV('pre_b'), getV('pre_g'), getT('pre_t'));
                stats.push(getV('suc_b'), getV('suc_g'), getT('suc_t'));
                stats.push(getV('fail_b'), getV('fail_g'), getT('fail_t'));
                stats.push(getV('abs_b'), getV('abs_g'), getT('abs_t'));
                stats.push(enrT); // Redundant enrollment for alignment

                subjectsConfig[currentGrade].forEach((_, idx) => {
                    let ab = parseFloat(getV(`app_b_${idx}`)) || 0;
                    let ag = parseFloat(getV(`app_g_${idx}`)) || 0;
                    let pb = parseFloat(getV(`pre_b_${idx}`)) || 0;
                    let pg = parseFloat(getV(`pre_g_${idx}`)) || 0;
                    let sb = parseFloat(getV(`suc_b_${idx}`)) || 0;
                    let sg = parseFloat(getV(`suc_g_${idx}`)) || 0;

                    let fb = Math.max(0, pb - sb);
                    let fg = Math.max(0, pg - sg);

                    // SAVE 8 COLUMNS PER SUBJECT: AppB, AppG, PreB, PreG, SucB, SucG, FailB, FailG
                    stats.push(ab, ag, pb, pg, sb, sg, fb, fg);
                });

                fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "saveStats", grade: currentGrade, schoolId: currentSchool.id, schoolName: currentSchool.name, schoolType: currentSchool.type, statsData: stats })
                })
                    .then(res => res.json())
                    .then(data => {
                        btn.disabled = false; btn.innerText = "๐พ ุญูุธ ุงูุจูุงูุงุช";
                        if (data.status === "success") Swal.fire('ุชู ุงูุญูุธ!', data.message, 'success');
                        else Swal.fire('ุฎุทุฃ', data.message || "ุญุฏุซ ุฎุทุฃ", 'error');
                    })
                    .catch(err => {
                        btn.disabled = false; btn.innerText = "๐พ ุญูุธ ุงูุจูุงูุงุช";
                        Swal.fire('ุฎุทุฃ', 'ูุดู ุงูุญูุธ: ' + err.message, 'error');
                    });

            } catch (e) {
                Swal.fire('ุฎุทุฃ ูู ุงูุจูุงูุงุช', e.message, 'error');
                if (btn) { btn.disabled = false; btn.innerText = "๐พ ุญูุธ ุงูุจูุงูุงุช"; }
            }
        }

        function loadSavedDataForGrade(g) {
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "getSchoolStats", grade: g, schoolId: currentSchool.id }) })
                .then(r => r.json()).then(d => { if (d.hasData) populateFormWithData(d.statsData, g); });
        }

        function populateFormWithData(data, grade) {
            const setV = (id, v) => { if (document.getElementById(id)) document.getElementById(id).value = v; };
            setV('enr_b', data[1]); setV('enr_g', data[2]); setV('pre_b', data[4]); setV('pre_g', data[5]);
            setV('suc_b', data[7]); setV('suc_g', data[8]);
            calcGenRow();
            let enrB = parseFloat(data[1]) || 0, enrG = parseFloat(data[2]) || 0;
            // DETECT DATA VERSION: Old (3 cols/subj) vs New (8 cols/subj)
            // Header (17 cols) + N * ColsPerSubj
            let numSubjects = subjectsConfig[grade].length;
            let isNewFormat = data.length > (17 + numSubjects * 4); // If clearly longer than old format

            subjectsConfig[grade].forEach((_, idx) => {
                let ab, ag, pb, pg, sb, sg;

                if (isNewFormat) {
                    // NEW FORMAT: 8 Cols (Starts at 17) -> 17 + idx*8
                    let base = 17 + (idx * 8);
                    // 0:Ab, 1:Ag, 2:Pb, 3:Pg, 4:Sb, 5:Sg, 6:Fb, 7:Fg
                    ab = parseFloat(data[base]) || 0;
                    ag = parseFloat(data[base + 1]) || 0;
                    pb = parseFloat(data[base + 2]) || 0;
                    pg = parseFloat(data[base + 3]) || 0;
                    sb = parseFloat(data[base + 4]) || 0;
                    sg = parseFloat(data[base + 5]) || 0;
                } else {
                    // OLD FORMAT: 3 Cols (Starts at 17) -> 17 + idx*3
                    // Data was SAVED as Totals: [TotalPre, TotalSuc, TotalFail]
                    let base = 17 + (idx * 3);
                    let totPre = parseFloat(data[base]) || 0;
                    let totSuc = parseFloat(data[base + 1]) || 0;
                    // totFail (base+2) is not directly used for setting P/S, but implied.

                    if (enrB === 0 && enrG > 0) {
                        // Girls Only
                        ab = 0; ag = enrG;
                        pb = 0; pg = totPre;
                        sb = 0; sg = totSuc;
                    } else if (enrG === 0 && enrB > 0) {
                        // Boys Only
                        ab = enrB; ag = 0;
                        pb = totPre; pg = 0;
                        sb = totSuc; sg = 0;
                    } else {
                        // MIXED SCHOOL (Legacy Data) -> Proportional Split
                        // This prevents dumping everything into Boys.
                        let totalEnr = enrB + enrG;
                        let ratio = totalEnr > 0 ? (enrB / totalEnr) : 0.5;

                        ab = enrB;
                        ag = enrG;

                        // Split Present
                        pb = Math.round(totPre * ratio);
                        pg = totPre - pb;

                        // Split Success (Constrained by Present)
                        // We check success ratio relative to present or just enrollment?
                        // Enrollment ratio is safest guess.
                        // Ensure success <= present for each gender
                        let rawSb = Math.round(totSuc * ratio);
                        sb = Math.min(rawSb, pb); // Cannot have more success than present
                        let rawSg = totSuc - rawSb;
                        sg = Math.min(rawSg, pg);

                        // Adjust if rounding caused sum mismatch with TotalSuccess?
                        // If sb+sg != totSuc.
                        // Ideally we prioritize the gender split logic.
                        // If (sb+sg) < totSuc, dump remainder in larger group?
                        // Let's keep it simple. Small error (1 student) is acceptable for "Restored" data.
                        // But actually: totSuc - sB might be > pg.
                        // Let's refine:
                        if (sg > pg) { sg = pg; sb = totSuc - sg; } // Shift overflow
                        if (sb > pb) { sb = pb; sg = totSuc - sb; }
                    }
                }

                setV(`app_b_${idx}`, ab); setV(`app_g_${idx}`, ag);
                setV(`pre_b_${idx}`, pb); setV(`pre_g_${idx}`, pg);
                setV(`suc_b_${idx}`, sb); setV(`suc_g_${idx}`, sg);

                calcSubjRow(idx);
            });
        }

        // --- NEW EVAL LOGIC ---
        function showEvalGrade(grade) {
            currentEvalGrade = grade;
            const gradeText = grade === 1 ? 'ุงูุฃูู' : 'ุงูุซุงูู';

            document.getElementById('dashboard-screen').style.display = 'none';
            document.getElementById('eval-dashboard-screen').style.display = 'block';

            document.getElementById('eval-grade-title').innerText = `ุงูุตู ${gradeText} ุงูุงุจุชุฏุงุฆู`;

            renderEvalInputTable('arabic', grade);
            renderEvalInputTable('math', grade);
            renderEvalInputTable('english', grade);

            if (currentSchool.id) loadEvalDataForGrade(grade);
        }

        function backToExamGrades() {
            document.getElementById('eval-dashboard-screen').style.display = 'none';
            document.getElementById('dashboard-screen').style.display = 'block';
            showGrade(3);
        }

        function renderEvalInputTable(subject, grade) {
            const gradeText = grade === 1 ? 'ุงูุฃูู' : 'ุงูุซุงูู';
            const tbody = document.getElementById(`${subject}-eval-body`);
            tbody.innerHTML = `<tr>
                <td style="font-weight: bold; background: #fafafa;">${gradeText}</td>
                <td><input type="number" id="${subject}_enrolled" class="eval-input" oninput="calcEvalRow('${subject}')" placeholder="0"></td>
                <td><input type="number" id="${subject}_absent" class="eval-input" oninput="calcEvalRow('${subject}')" placeholder="0" readonly style="background:#f0f0f0;"></td>
                <td><input type="number" id="${subject}_present" class="eval-input" oninput="calcEvalRow('${subject}')" placeholder="0"></td>
                <td><input type="number" id="${subject}_pass60" class="eval-input" oninput="calcEvalRow('${subject}')" placeholder="0"></td>
                <td><input type="number" id="${subject}_less60" class="eval-input" oninput="calcEvalRow('${subject}')" placeholder="0" readonly style="background:#f0f0f0;"></td>
            </tr>`;
        }

        function calcEvalRow(subj) {
            const get = (id) => parseFloat(document.getElementById(id)?.value) || 0;
            let enr = get(`${subj}_enrolled`), pre = get(`${subj}_present`), pass = get(`${subj}_pass60`);
            document.getElementById(`${subj}_absent`).value = Math.max(0, enr - pre);
            document.getElementById(`${subj}_less60`).value = Math.max(0, pre - pass);
        }

        function saveEvalData() {
            // USING NEW ACTION HERE
            const btn = document.querySelector('button[onclick="saveEvalData()"]');
            btn.innerText = "..."; btn.disabled = true;

            let evalData = [];
            evalSubjects.forEach(s => {
                let enr = document.getElementById(`${s}_enrolled`).value, abs = document.getElementById(`${s}_absent`).value, pre = document.getElementById(`${s}_present`).value;
                let p60 = document.getElementById(`${s}_pass60`).value, l60 = document.getElementById(`${s}_less60`).value;
                evalData.push(enr, abs, pre, p60, l60);
            });

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "saveEvalStats", // Fixed name
                    grade: currentEvalGrade,
                    schoolId: currentSchool.id,
                    schoolName: currentSchool.name,
                    schoolType: currentSchool.type,
                    evalData: evalData
                })
            })
                .then(res => res.json())
                .then(data => {
                    btn.disabled = false; btn.innerText = "๐พ ุญูุธ ุจูุงูุงุช ุงูุชูููู";
                    if (data.status === "success") Swal.fire('ุชู', 'ุชู ุงูุญูุธ ุจูุฌุงุญ', 'success');
                    else Swal.fire('ุฎุทุฃ', data.message, 'error');
                });
        }

        function loadEvalDataForGrade(g) {
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "getEvalStats", grade: g, schoolId: currentSchool.id }) })
                .then(r => r.json()).then(d => {
                    if (d.hasData) {
                        // Populate
                        let data = d.evalData;
                        const setV = (id, v) => document.getElementById(id).value = v;
                        setV('arabic_enrolled', data[0]); setV('arabic_absent', data[1]); setV('arabic_present', data[2]); setV('arabic_pass60', data[3]); setV('arabic_less60', data[4]);
                        setV('math_enrolled', data[5]); setV('math_absent', data[6]); setV('math_present', data[7]); setV('math_pass60', data[8]); setV('math_less60', data[9]);
                        setV('english_enrolled', data[10]); setV('english_absent', data[11]); setV('english_present', data[12]); setV('english_pass60', data[13]); setV('english_less60', data[14]);
                    }
                });
        }

        function printEvalReport() {
            // Generate the Consolidated Print Table
            const printArea = document.getElementById('eval-print-area-container');
            if (!printArea) {
                // Create container if not exists
                const div = document.createElement('div');
                div.id = 'eval-print-area-container';
                div.className = 'print-only';
                document.body.appendChild(div);
            }

            const container = document.getElementById('eval-print-area-container');
            const gradeText = currentEvalGrade === 1 ? 'ุงูุฃูู' : 'ุงูุซุงูู';

            // Header
            let html = `
            <div class="print-header-container" style="display:flex; justify-content:space-between; align-items:start; margin-bottom:20px;">
                <div style="flex:1; text-align:right; font-size:16pt; line-height:1.4; font-weight:bold;"> <!-- Increased -->
                    ูุญุงูุธุฉ ุงูุฌูุฒุฉ <br> ูุฏูุฑูุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู <br> ุงูุชุนููู ุงูุงุจุชุฏุงุฆู
                </div>
                <div style="flex:2; text-align:center;">
                    <div style="font-weight:bold; font-size:24pt; text-decoration:underline;"> <!-- Main Title Increased -->
                        ุฅุญุตุงุก ุงูุชูููู ุงููุจุฏุฆู ูุงูููุงุฆู
                    </div>
                    <div style="font-weight:bold; font-size:20pt; margin-top:10px;">ุงูุตู ${gradeText} ุงูุงุจุชุฏุงุฆู</div>
                    <div style="font-weight:bold; font-size:20pt; margin-top:10px;">ุฅุฏุงุฑุฉ ุงูุนูุฑุงููุฉ ุงูุชุนููููุฉ</div>
                    <div style="margin-top:10px; font-size:18pt;">ูุฏุฑุณุฉ: ${currentSchool.name}</div>
                    <div style="margin-top:10px; font-size:18pt;">ุงูุนุงู ุงูุฏุฑุงุณู 2025 / 2026</div>
                </div>
                <div style="flex:1; text-align:left;">
                    <img src="logo.jpg" style="height:90px; width:auto;" alt="Logo" onerror="this.style.display='none'">
                </div>
            </div>`;

            // Table
            html += `
            <table class="admin-table-official" style="width:100%; border: 3px solid #000; margin-top:30px; table-layout: fixed;">
                <colgroup>
                    <col style="width: 15%;"> <!-- Subject -->
                    <col style="width: 17%;"> <!-- Enrolled -->
                    <col style="width: 17%;"> <!-- Absent -->
                    <col style="width: 17%;"> <!-- Present -->
                    <col style="width: 17%;"> <!-- Good -->
                    <col style="width: 17%;"> <!-- Needs Support -->
                </colgroup>
                <thead>
                    <tr style="background:#f0f0f0;">
                        <th rowspan="2" style="font-size:22pt; padding:10px;">ุงููุงุฏุฉ</th>
                        <th colspan="3" style="font-size:22pt; padding:10px;">ุฅุญุตุงุก ุงูุทูุงุจ</th>
                        <th colspan="2" style="font-size:22pt; padding:10px;">ุงูุชูููู</th>
                    </tr>
                    <tr style="background:#f0f0f0;">
                        <th style="font-size:20pt; padding:10px;">ูููุฏ</th>
                        <th style="font-size:20pt; padding:10px;">ุบุงุฆุจ</th>
                        <th style="font-size:20pt; padding:10px;">ุญุงุถุฑ</th>
                        <th style="font-size:20pt; padding:10px;">60% ูุฃูุซุฑ (ูุฌูุฏ)</th>
                        <th style="font-size:20pt; padding:10px;">ุฃูู ูู 60% (ูุญุชุงุฌ ุฏุนู)</th>
                    </tr>
                </thead>
                <tbody>`;

            evalSubjects.forEach(s => {
                const get = (id) => document.getElementById(id).value || 0;
                html += `
                    <tr style="height: 70px;"> <!-- Increased row height for larger font -->
                        <td style="font-weight:bold; font-size:24pt;">${evalSubjectsNames[s]}</td>
                        <td style="font-size:24pt; font-weight:bold;">${get(s + '_enrolled')}</td>
                        <td style="font-size:24pt; font-weight:bold;">${get(s + '_absent')}</td>
                        <td style="font-size:24pt; font-weight:bold;">${get(s + '_present')}</td>
                        <td style="font-size:24pt; font-weight:bold;">${get(s + '_pass60')}</td>
                        <td style="font-size:24pt; font-weight:bold;">${get(s + '_less60')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            // Signatures
            html += `
            <div class="print-footer-container" style="display:flex; justify-content:space-around; margin-top:50px; font-weight:bold;">
                <div style="text-align:center;">
                    <div>ูุฏูุฑ ุงููุฑุญูุฉ</div>
                    <div style="margin-top:40px; border-top:1.5px solid #000; min-width:180px;"></div>
                </div>
                <div style="text-align:center;">
                    <div>ูุฏูุฑ ุงููุฏุฑุณุฉ</div>
                    <div style="margin-top:40px; border-top:1.5px solid #000; min-width:180px;"></div>
                </div>
            </div>`;

            container.innerHTML = html;

            // Trigger Print
            document.body.classList.add('print-mode-eval-summary');
            window.print();
            setTimeout(() => document.body.classList.remove('print-mode-eval-summary'), 1000);
        }

        /* --- Export to Excel for Eval --- */
        function exportEvalToExcel() {
            /* Simplify for space */
            Swal.fire('ุชู', 'ุชุตุฏูุฑ ุฅูุณู ููุชูููู ููุฏ ุงูุชูููุฐ (ููุณ ููุทู ุงูุฅุญุตุงุก ุงูุนุงู)', 'info');
        }

    </script>
</body>

</html>